<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鳳甲國中成績查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;1,400&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); background-attachment: fixed; min-height: 100vh; overflow-x: hidden; }
        
        /* --- 動畫與通用 --- */
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-row-anim { opacity: 0; transform: translateX(-10px); animation: slideInLeft 0.5s ease-out forwards; }
        @keyframes slideInLeft { to { opacity: 1; transform: translateX(0); } }
        .text-title-size { font-size: 20px !important; line-height: 1.4; }
        .text-content-size { font-size: 18px !important; line-height: 1.4; }
        @media (min-width: 768px) { .text-title-size { font-size: 24px !important; } .text-content-size { font-size: 22px !important; } }
        
        /* --- 溫馨小語 & 互動 --- */
        .quote-container { background-color: #fff9c4; border-left: 5px solid #fbc02d; transition: all 0.3s ease; position: relative; }
        .quote-container:hover { transform: scale(1.01); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .font-english { font-family: 'Lora', serif; }
        .speak-btn { cursor: pointer; transition: all 0.2s; }
        .speak-btn:hover { color: #d97706; transform: scale(1.1); }
        .vocab-highlight { border-bottom: 2px dashed #d97706; cursor: pointer; color: #b45309; font-weight: 600; position: relative; transition: all 0.2s ease; display: inline-block; user-select: none; -webkit-tap-highlight-color: rgba(253, 230, 138, 0.5); }
        .vocab-highlight:hover, .vocab-highlight.active { background-color: #fef3c7; color: #92400e; transform: translateY(-2px); }
        
        /* --- Tooltip --- */
        #vocabTooltip { opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; position: fixed; z-index: 10000; pointer-events: none; }
        #vocabTooltip.show { opacity: 1; visibility: visible; }
        .tooltip-arrow { position: absolute; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }
        .tooltip-arrow.bottom { bottom: -8px; border-top: 8px solid white; filter: drop-shadow(0 2px 1px rgba(0,0,0,0.1)); }
        .tooltip-arrow.top { top: -8px; border-bottom: 8px solid white; filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.1)); }

        /* --- 遊戲區塊 --- */
        .game-container { background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 4px solid #10b981; transition: all 0.3s ease; }
        .game-option-btn { border: 2px solid #e5e7eb; background-color: white; transition: all 0.2s; font-size: 1.1rem; }
        .game-option-btn:hover:not(:disabled) { border-color: #3b82f6; background-color: #eff6ff; transform: translateY(-2px); }
        .game-option-btn.correct { background-color: #d1fae5; border-color: #10b981; color: #065f46; font-weight: bold; transform: scale(1.02); }
        .game-option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #fde68a; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #d97706; cursor: pointer; -webkit-appearance: none; margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* ================= 煙火特效 (層級最高) ================= */
        .firework {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 0.5rem; aspect-ratio: 1; background: #0000; border-radius: 50%;
            animation: firework 2s infinite; pointer-events: none;
            z-index: 20003; 
        }
        @keyframes firework {
            0% { transform: translate(-50%, -50%); width: 0.5rem; opacity: 1; box-shadow: 0 0 0 0px red; }
            50% { width: 0.5rem; opacity: 1; }
            100% { width: 45rem; opacity: 0; 
                box-shadow: 0 0 0 0 transparent,
                -15rem -20rem 0 -0.2rem #ff0000, 15rem -20rem 0 -0.2rem #ffff00, 15rem 20rem 0 -0.2rem #00ff00, -15rem 20rem 0 -0.2rem #0000ff,
                -9rem -25rem 0 -0.2rem #ff00ff, 9rem -25rem 0 -0.2rem #00ffff, 9rem 25rem 0 -0.2rem #ffffff, -9rem 25rem 0 -0.2rem #ffa500;
            }
        }

        /* ================= 3D 閃卡特效樣式 ================= */
        .reward-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.5s;
            backdrop-filter: blur(8px); perspective: 1000px;
        }
        .reward-overlay.show { opacity: 1; visibility: visible; }

        .poke-card {
            width: 300px; height: 440px; border-radius: 18px; position: relative;
            transform-style: preserve-3d; transition: transform 0.1s;
            border: 8px solid; overflow: hidden; cursor: pointer;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            background-size: cover;
            -webkit-user-select: none; user-select: none;
            touch-action: none;
        }

        /* 閃卡等級：金 (Legendary) */
        .poke-card.legendary {
            border-color: #ffd700;
            background: linear-gradient(135deg, #2b2b2b 0%, #5e5e5e 50%, #2b2b2b 100%);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), 0 0 80px rgba(255, 0, 0, 0.4);
        }
        .poke-card.legendary .poke-card-inner { background: rgba(255, 215, 0, 0.1); }

        /* 閃卡等級：幻之 (Mythical) */
        .poke-card.mythical {
            border-color: #d8b4fe;
            background: linear-gradient(135deg, #2e1065 0%, #7e22ce 50%, #2e1065 100%);
            box-shadow: 0 0 30px rgba(216, 180, 254, 0.7);
        }
        .poke-card.mythical .poke-card-inner { background: rgba(216, 180, 254, 0.1); }

        /* 閃卡等級：一般 (Normal) */
        .poke-card.normal {
            border-color: #94a3b8;
            background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 50%, #f1f5f9 100%);
            box-shadow: 0 0 20px rgba(148, 163, 184, 0.5);
        }
        .poke-card.normal .poke-card-inner { background: rgba(255, 255, 255, 0.4); }

        /* ★★★ 紅彩流光特效 ★★★ */
        .holo-overlay {
            position: absolute; inset: 0; z-index: 6; pointer-events: none;
            mix-blend-mode: color-dodge; 
            background: linear-gradient(115deg, transparent 20%, rgba(255,0,0,0.5) 25%, rgba(255,255,0,0.5) 30%, rgba(0,255,0,0.5) 35%, rgba(0,255,255,0.5) 40%, rgba(0,0,255,0.5) 45%, rgba(255,0,255,0.5) 50%, transparent 60%);
            background-size: 250% 250%;
            opacity: 0.6; filter: brightness(1.2) contrast(1.1);
            animation: holo-drift 3.5s linear infinite;
        }
        .poke-card.normal .holo-overlay { opacity: 0.3; animation: holo-drift 5s linear infinite; }

        @keyframes holo-drift {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        .poke-card-inner { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 12px; position: relative; z-index: 4; }
        .poke-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); z-index: 7; }
        
        .card-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; }
        .tag-type { background-color: #059669; }
        .tag-special { background-color: #4f46e5; }

        .poke-img-frame {
            width: 100%; aspect-ratio: 4/3; margin-bottom: 12px;
            background: rgba(255,255,255,0.85); border: 4px solid rgba(255,255,255,0.5);
            border-radius: 8px; overflow: hidden; display: flex; justify-content: center; align-items: center;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);
            z-index: 5; position: relative;
        }
        .poke-img-content { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.4)); transition: transform 0.3s; }
        .poke-card:hover .poke-img-content { transform: scale(1.1); }

        .poke-info { width: 100%; text-align: center; background: rgba(255,255,255,0.9); padding: 8px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 7; }
        .poke-name { font-size: 1.4rem; font-weight: 800; color: #1e293b; line-height: 1.2; margin-bottom: 2px; }
        .poke-eng-name { font-size: 0.9rem; color: #64748b; font-family: 'Lora', serif; font-weight: bold; font-style: italic; margin-bottom: 5px; }
        .poke-stars { color: #f59e0b; font-size: 0.9rem; margin-bottom: 2px; letter-spacing: 2px; }
        
        /* 物理反光 */
        .glare {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 18px;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.95) 0%, transparent 60%);
            mix-blend-mode: overlay; opacity: 0; pointer-events: none; z-index: 10;
        }

        .close-reward-btn {
            margin-top: 30px; background: white; color: #333; font-weight: bold; padding: 12px 40px;
            border-radius: 50px; border: none; cursor: pointer; font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(255,255,255,0.5); transition: all 0.2s; z-index: 20001;
        }
        .close-reward-btn:hover { transform: scale(1.05); background: #f8fafc; color: #000; box-shadow: 0 0 30px rgba(255,255,255,0.8); }
        
        .sparkle {
            position: absolute; background: white; border-radius: 50%; box-shadow: 0 0 8px white, 0 0 15px gold; opacity: 0;
            animation: sparkle-anim 1.5s linear infinite; z-index: 20;
        }
        @keyframes sparkle-anim { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
    </style>
</head>
<body class="flex flex-col items-center py-4 md:py-8 px-2 md:px-4">

    <!-- 煙火特效層 -->
    <div id="fireworksLayer" class="fixed inset-0 pointer-events-none z-[20003] hidden"></div>

    <!-- 金卡獎勵視窗 -->
    <div id="rewardModal" class="reward-overlay">
        <div class="flex flex-col items-center perspective-container">
            <h2 class="text-white text-3xl md:text-5xl font-bold mb-10 animate-bounce text-center drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)]">
                <i class="fas fa-crown text-yellow-300 mr-2"></i>CHALLENGE CLEAR!<i class="fas fa-crown text-yellow-300 ml-2"></i>
            </h2>
            <div id="rewardCardContainer" class="relative"></div>
            <button class="close-reward-btn" onclick="closeReward()">
                <i class="fas fa-check mr-2"></i> 收下卡片 (Claim)
            </button>
            <p id="rewardMsg" class="text-white mt-4 text-sm opacity-80 font-mono tracking-widest text-center">STREAK 10 COMPLETED</p>
        </div>
    </div>

    <!-- 單字 Tooltip -->
    <div id="vocabTooltip" class="bg-white border border-gray-200 shadow-2xl rounded-lg p-4 max-w-xs w-full md:w-80 text-left">
        <div class="flex justify-between items-start mb-1">
            <div>
                <h4 id="tt-word" class="text-xl font-bold text-blue-700 font-english capitalize inline-block"></h4>
                <span id="tt-ipa" class="text-sm text-gray-500 font-mono ml-2"></span>
            </div>
            <i class="fas fa-volume-up text-blue-500 animate-pulse"></i>
        </div>
        <div class="space-y-2">
            <p class="text-sm text-gray-800 border-l-2 border-blue-400 pl-2">
                <span id="tt-def-zh" class="font-bold"></span> 
            </p>
            <div class="bg-blue-50 p-2 rounded text-xs mt-2 relative group min-h-[40px] hidden" id="tt-ex-container">
                <div id="tt-loading" class="absolute inset-0 flex items-center justify-center bg-blue-50 bg-opacity-80 hidden">
                    <div class="loading-spinner" style="width:16px; height:16px; border-width:2px; border-top-color:#2563eb;"></div>
                    <span class="ml-2 text-gray-500 italic">查詢中...</span>
                </div>
                <button id="btn-read-ex" class="absolute top-1 right-1 text-blue-300 hover:text-blue-600 transition-colors hidden" title="朗讀例句"><i class="fas fa-volume-up"></i></button>
                <p id="tt-ex-en" class="text-blue-900 font-english italic mb-1 pr-5"></p>
                <p id="tt-ex-zh" class="text-gray-600"></p>
            </div>
            <div id="tt-analysis-container" class="mt-2 pt-2 border-t border-gray-100 hidden">
                <p class="text-xs text-orange-600 font-bold mb-1"><i class="fas fa-project-diagram mr-1"></i>字根分析：</p>
                <p id="tt-analysis" class="text-xs text-gray-700"></p>
            </div>
        </div>
        <div id="tooltipArrow" class="tooltip-arrow bottom"></div>
    </div>

    <!-- 主容器 -->
    <div class="w-full max-w-7xl bg-white rounded-xl shadow-2xl overflow-hidden fade-in-up bg-opacity-95">
        <div class="w-full bg-blue-50 border-b border-gray-200 text-center relative group">
            <img src="https://lh3.googleusercontent.com/d/1JmsYaXfbxskAaw9WXraX2gyi6a0W9--1" alt="標題" referrerpolicy="no-referrer" class="max-w-full h-auto mx-auto object-contain" style="max-height: 200px; md:max-height: 250px;" onerror="this.style.display='none'; document.getElementById('backup-title').style.display='block';">
            <div id="backup-title" style="display:none;" class="py-10"><h1 class="font-bold text-gray-800 tracking-wide text-title-size">鳳甲國中成績查詢系統</h1><p class="text-sm text-gray-500 mt-2">(Google Drive 圖片讀取失敗)</p></div>
        </div>

        <div class="w-full px-4 md:px-6 py-4 bg-yellow-50">
            <div class="quote-container p-4 rounded-r-lg flex flex-col md:flex-row items-start md:items-center shadow-sm">
                <div class="mr-0 md:mr-5 text-yellow-600 mb-3 md:mb-0 self-start"><i class="fas fa-lightbulb text-3xl"></i></div>
                <div class="flex-1 w-full">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2 border-b border-yellow-200 pb-2">
                        <div class="flex flex-col">
                            <h3 class="font-bold text-gray-800 text-lg mb-0">每日名言佳句 Quote of the Day</h3>
                            <span class="text-xs text-orange-600 font-bold"><i class="fas fa-hand-pointer mr-1"></i>滑鼠移至(或點擊)英文單字查閱</span>
                        </div>
                        <div class="flex items-center bg-white px-3 py-1.5 rounded-full shadow-sm border border-yellow-100 mt-2 md:mt-0">
                            <span class="text-xs text-gray-500 mr-2 flex items-center"><i class="fas fa-tachometer-alt mr-1"></i> 語速</span>
                            <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.9" class="w-24 mr-2">
                            <span id="rateValue" class="text-xs font-bold text-yellow-700 w-8 text-right">0.9x</span>
                        </div>
                    </div>
                    <div id="dailyQuote" class="transition-opacity duration-300 mt-2 relative">
                        <div id="quoteLoading" class="flex items-center text-gray-500"><div class="loading-spinner mr-2" style="width:20px; height:20px; border-width:3px;"></div>讀取名言中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 英文挑戰區 -->
        <div class="w-full px-4 md:px-6 mb-4">
            <div class="game-container relative">
                <div class="flex justify-between items-center cursor-pointer select-none" onclick="toggleGame()">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center flex-wrap">
                        <i class="fas fa-gamepad text-green-500 mr-2 text-2xl"></i>
                        英文單字挑戰
                        <span class="ml-2 text-sm text-red-500 font-bold hidden md:inline">國中1200單字挑戰(全對抽寶可夢)</span>
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Challenge</span>
                    </h3>
                    <i class="fas fa-chevron-down text-gray-400 transform transition-transform duration-300" id="gameToggleIcon"></i>
                </div>
                
                <div id="gameContent" class="hidden mt-4 border-t border-gray-100 pt-4">
                    <div id="gameLoading" class="hidden text-center py-10"><div class="loading-spinner mx-auto mb-2"></div><p class="text-gray-500">正在下載題庫...</p></div>
                    <div id="gameBody" class="hidden">
                        <div class="text-center mb-6 relative">
                            <div class="absolute top-0 right-0 text-xs text-gray-400">Goal: <span class="font-bold text-indigo-600">Streak 10</span></div>
                            <div id="q-word" class="text-4xl md:text-5xl font-bold text-indigo-600 font-english mb-2 tracking-wide">Loading...</div>
                            <div class="flex justify-center items-center gap-2 mb-2">
                                <span id="q-type" class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wider">Word</span>
                                <button onclick="playCurrentGameAudio()" class="text-gray-400 hover:text-indigo-600 focus:outline-none transition-colors"><i class="fas fa-volume-up text-xl"></i></button>
                            </div>
                            <p class="text-gray-500 text-sm">請選擇正確的中文意思：</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-grid"></div>
                        <div id="gameAnalysis" class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-gray-700 hidden text-center">
                            <i class="fas fa-search-plus text-yellow-600 mr-1"></i><span class="font-bold text-yellow-700">補充分析：</span><span id="gameAnalysisText"></span>
                        </div>
                        <div class="mt-6 flex justify-between items-center border-t border-gray-100 pt-4">
                            <div class="flex items-center"><span class="text-sm text-gray-500 mr-2">連續答對 Streak:</span><span id="streak-count" class="font-bold text-orange-500 text-xl">0</span><span class="text-gray-300 mx-1">/</span><span class="text-gray-400 text-sm">10</span><i class="fas fa-fire text-orange-500 ml-1 animate-pulse" id="streak-icon" style="display:none;"></i></div>
                            <div id="lastOneHint" class="hidden text-red-500 font-bold animate-pulse text-lg">最後一題！加油！(One more!)</div>
                            <button id="nextQBtn" onclick="nextQuestion()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md transition transform hover:scale-105 flex items-center">下一題 Next <i class="fas fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6 lg:p-10">
            <form id="searchForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="studentId"><i class="fas fa-id-card text-blue-500 mr-2"></i>學號</label><input class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-content-size hover:shadow-md" id="studentId" type="text" placeholder="請輸入學號" required></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="idLast4"><i class="fas fa-lock text-blue-500 mr-2"></i>身分證後4碼</label><div class="relative"><input class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 pr-12 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-content-size hover:shadow-md" id="idLast4" type="password" placeholder="後4碼" maxlength="6" required><button type="button" id="toggleIdVisibility" class="absolute inset-y-0 right-0 px-4 flex items-center text-gray-500 hover:text-blue-600 focus:outline-none z-10 cursor-pointer transition-transform hover:scale-110"><i class="fas fa-eye text-2xl"></i></button></div></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="yearSelect"><i class="fas fa-calendar-alt text-blue-500 mr-2"></i>學年度</label><div class="relative"><select id="yearSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="" disabled selected>載入中...</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div></div></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="semesterSelect"><i class="fas fa-clock text-blue-500 mr-2"></i>學期 (選填)</label><div class="relative"><select id="semesterSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="">全部</option><option value="1">上學期 (1)</option><option value="2">下學期 (2)</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div></div></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="examSelect"><i class="fas fa-file-alt text-blue-500 mr-2"></i>段考 (選填)</label><div class="relative"><select id="examSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="">全部</option><option value="1">第一次段考 (1)</option><option value="2">第二次段考 (2)</option><option value="3">第三次段考 (3)</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div></div></div>
                <div class="col-span-1 md:col-span-2 lg:col-span-3 flex flex-col sm:flex-row justify-center gap-4 md:gap-6 mt-6">
                    <button type="button" id="searchBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center shadow-md text-title-size"><i class="fas fa-search mr-3"></i> 查詢</button>
                    <button type="button" id="clearBtn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-12 rounded-lg focus:outline-none focus:ring-4 focus:ring-gray-300 transition duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center shadow-md text-title-size"><i class="fas fa-eraser mr-3"></i> 清除</button>
                </div>
            </form>
            <div id="messageArea" class="mt-6 text-center hidden p-4 rounded-lg text-content-size font-bold"></div>
            <div id="loading" class="hidden flex flex-col justify-center items-center mt-12 mb-8"><div class="loading-spinner mb-4" style="width: 50px; height: 50px; border-width: 6px;"></div><span class="text-gray-600 font-medium animate-pulse text-title-size">正在從資料庫查詢中...</span></div>
        </div>

        <div id="resultArea" class="hidden border-t-4 border-blue-600 bg-gray-50 transition-all duration-500">
            <div class="p-4 md:p-6">
                <h2 class="font-bold text-gray-800 mb-6 border-l-8 border-blue-500 pl-4 text-title-size">查詢結果</h2>
                <div class="table-container bg-white rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead><tr class="bg-gray-100 text-gray-800 uppercase font-bold tracking-wider text-title-size"><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">學年度</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">學期</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">段考</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">班級</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">座號</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">姓名</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">國語</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">英文</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">數學</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">歷史</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">地理</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">公民</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">自然</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">地科</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 text-red-600 font-extrabold bg-red-50 whitespace-nowrap">加權平均</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 whitespace-nowrap">考科班排</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 whitespace-nowrap">考科校排</th></tr></thead>
                        <tbody id="resultBody" class="text-gray-700 text-content-size"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="bg-gray-100 border-t border-gray-200 py-6 text-center text-gray-500 text-content-size px-4">&copy; <span id="currentYear"></span> 鳳甲國中成績查詢系統 <span class="text-xs text-gray-400 ml-1">v2.0</span> | <span class="text-blue-500 italic font-english block md:inline mt-2 md:mt-0">Believe in yourself.</span></div>
    </div>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const GAS_URL = "https://script.google.com/macros/s/AKfycbykiv2Rn3tRq1eaR8Yee5m8hfEwCN1naxrE8BAxoBNyDAPlizkT7S9l_RIUOTTqctycvQ/exec";

        let quotes=[], gameData=[], pokemonData=[];
        let currentQuestion=null, currentQuoteData=null;
        let streak=0, isGameOpen=false;
        const TARGET_STREAK=10;
        const wordCache={}; 

        const rateInput=document.getElementById('speechRate');
        const rateValue=document.getElementById('rateValue');
        const tooltip=document.getElementById('vocabTooltip');
        const ttWord=document.getElementById('tt-word');
        const ttDefZh=document.getElementById('tt-def-zh');
        const ttExEn=document.getElementById('tt-ex-en'), ttExZh=document.getElementById('tt-ex-zh');
        const ttIpa=document.getElementById('tt-ipa');
        const ttAnalysis=document.getElementById('tt-analysis');
        const ttAnalysisContainer=document.getElementById('tt-analysis-container');
        const btnReadEx=document.getElementById('btn-read-ex');
        const ttExContainer=document.getElementById('tt-ex-container');
        const ttLoading=document.getElementById('tt-loading');
        // New: Get the nextQBtn
        const nextQBtn = document.getElementById('nextQBtn');

        rateInput.addEventListener('input', (e)=>{rateValue.textContent=e.target.value+'x';});
        document.addEventListener('click', (e)=>{if(!tooltip.contains(e.target) && !e.target.classList.contains('vocab-highlight')) hideTooltip();});
        btnReadEx.addEventListener('click', (e)=>{e.stopPropagation(); if(ttExEn.textContent) playAudio(ttExEn.textContent);});

        window.addEventListener('load', ()=>{fetchYears(); fetchQuotes(); fetchGameData(); fetchPokemon();});

        async function callAPI(payload) {
            const res = await fetch(GAS_URL, {method:'POST', redirect:'follow', referrerPolicy:'no-referrer', headers:{"Content-Type":"text/plain;charset=utf-8"}, body:JSON.stringify(payload)});
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            const text = await res.text();
            try{return JSON.parse(text);}catch(e){throw new Error("JSON Error");}
        }

        async function fetchQuotes(){try{const res=await callAPI({action:"getQuotes"});if(res.status==="success"&&res.data.length>0){quotes=res.data;showRandomQuote();}else{document.getElementById('dailyQuote').innerHTML='<p class="text-red-500">暫無名言資料</p>';}}catch(e){console.error(e);}}
        async function fetchGameData(){try{const res=await callAPI({action:"getGameData"});if(res.status==="success"&&res.data.length>0){gameData=res.data;/*nextQuestion not called here*/}}catch(e){console.error(e);}}
        async function fetchPokemon(){try{const res=await callAPI({action:"getPokemon"});if(res.status==="success")pokemonData=res.data;}catch(e){console.error(e);}}

        function processQuoteWithKeywords(data){
            let html=data.en; if(!data.keywords||data.keywords.length===0)return html;
            const kws=data.keywords.map((k,i)=>({...k,idx:i})).sort((a,b)=>b.word.length-a.word.length);
            kws.forEach(k=>{const esc=k.word.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); html=html.replace(new RegExp(`\\b(${esc})\\b`,'gi'),(m)=>`###${k.idx}###${m}###END###`);});
            return html.replace(/###(\d+)###(.*?)###END###/g,(m,i,t)=>`<span class="vocab-highlight" data-kw-index="${i}" onclick="handleWordClick(event)">${t}</span>`);
        }

        function showRandomQuote(){
            if(quotes.length===0)return;
            currentQuoteData=quotes[Math.floor(Math.random()*quotes.length)];
            const html=processQuoteWithKeywords(currentQuoteData);
            const container=document.getElementById('dailyQuote');
            container.style.opacity=0;
            setTimeout(()=>{container.innerHTML=`<p class="text-gray-800 font-medium text-xl mb-1">${currentQuoteData.zh}</p><div class="relative"><p class="text-gray-600 font-normal italic text-lg font-english mr-3 leading-loose" id="enQuoteText">${html}<button onclick="speakQuote()" class="inline-block ml-2 text-yellow-600 hover:text-yellow-800 speak-btn focus:outline-none align-middle" title="朗讀"><i class="fas fa-volume-up text-xl"></i></button></p></div>`; container.style.opacity=1; document.querySelectorAll('.vocab-highlight').forEach(el=>el.addEventListener('mouseenter',(e)=>showTooltip(e.target)));},300);
        }

        function handleWordClick(e){e.stopPropagation(); showTooltip(e.target);}

        async function showTooltip(el){
            const idx=el.getAttribute('data-kw-index'); const data=currentQuoteData.keywords[idx]; if(!data)return;
            document.querySelectorAll('.vocab-highlight').forEach(e=>e.classList.remove('active')); el.classList.add('active');
            playAudio(data.word);
            ttWord.textContent=data.word; 
            if(data.analysis){ttAnalysisContainer.classList.remove('hidden'); ttAnalysis.textContent=data.analysis;}else{ttAnalysisContainer.classList.add('hidden');}
            
            // Positioning
            const rect=el.getBoundingClientRect(); const h=tooltip.offsetHeight||200, w=tooltip.offsetWidth||300;
            let top=rect.top-h-12, left=rect.left+rect.width/2-w/2;
            const arrow=document.getElementById('tooltipArrow'); arrow.className='tooltip-arrow bottom';
            if(top<10){top=rect.bottom+12; arrow.className='tooltip-arrow top';}
            if(left<10)left=10; if(left+w>window.innerWidth-10)left=window.innerWidth-w-10;
            arrow.style.left=`${Math.min(Math.max(rect.left+rect.width/2-left,15),w-15)}px`;
            tooltip.style.top=`${top}px`; tooltip.style.left=`${left}px`; tooltip.classList.add('show');

            if(!data.zh||!data.ex_en){
                const key=data.word.toLowerCase();
                if(wordCache[key]){updateTooltip(wordCache[key]);}else{
                    ttLoading.classList.remove('hidden'); ttExContainer.classList.remove('hidden'); btnReadEx.style.display='none';
                    ttDefZh.textContent="查詢中..."; ttExEn.textContent=""; ttExZh.textContent=""; ttIpa.textContent="";
                    try{
                        const res=await callAPI({action:"getWordInfo",word:data.word});
                        if(res.status==="success"){
                            const info=res.data; data.zh=info.def_zh; data.ex_en=info.ex_en; data.ex_zh=info.ex_zh; data.ipa=info.ipa;
                            wordCache[key]=data; updateTooltip(data);
                        }else{ttDefZh.textContent="查詢失敗"; ttLoading.classList.add('hidden');}
                    }catch(e){ttDefZh.textContent="網路錯誤"; ttLoading.classList.add('hidden');}
                }
            }else{updateTooltip(data);}
        }

        function updateTooltip(data){
            ttLoading.classList.add('hidden'); ttDefZh.textContent=data.zh||"無中文翻譯"; ttExEn.textContent=data.ex_en||""; ttExZh.textContent=data.ex_zh||""; ttIpa.textContent=data.ipa?`[${data.ipa}]`:"";
            if(data.ex_en&&data.ex_en!==""){ttExContainer.classList.remove('hidden'); btnReadEx.style.display='block';}else{ttExContainer.classList.add('hidden'); btnReadEx.style.display='none';}
        }
        function hideTooltip(){tooltip.classList.remove('show'); document.querySelectorAll('.vocab-highlight').forEach(e=>e.classList.remove('active'));}

        function toggleGame(){
            isGameOpen=!isGameOpen;
            const content=document.getElementById('gameContent'), icon=document.getElementById('gameToggleIcon');
            if(isGameOpen){
                content.classList.remove('hidden'); icon.classList.add('rotate-180');
                if(gameData.length===0){
                    document.getElementById('gameLoading').classList.remove('hidden'); document.getElementById('gameBody').classList.add('hidden');
                    fetchGameData().then(()=>{
                        if(gameData.length>0){document.getElementById('gameLoading').classList.add('hidden'); document.getElementById('gameBody').classList.remove('hidden'); if(!currentQuestion)nextQuestion();}
                    });
                }else{
                    document.getElementById('gameLoading').classList.add('hidden'); document.getElementById('gameBody').classList.remove('hidden'); if(!currentQuestion)nextQuestion();
                }
            }else{content.classList.add('hidden'); icon.classList.remove('rotate-180');}
        }

        function nextQuestion(){
            if(gameData.length===0)return;
            // Reset button style & text
            nextQBtn.innerHTML = '下一題 Next <i class="fas fa-arrow-right ml-2"></i>';
            nextQBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            nextQBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

            currentQuestion=gameData[Math.floor(Math.random()*gameData.length)];
            document.getElementById('q-word').textContent=currentQuestion.question;
            document.getElementById('q-type').textContent=currentQuestion.type;
            document.getElementById('gameAnalysis').classList.add('hidden');
            // Hide last one hint
            document.getElementById('lastOneHint').classList.add('hidden');
            const opts=[...currentQuestion.options].sort(()=>Math.random()-0.5);
            document.getElementById('options-grid').innerHTML=opts.map(o=>`<button onclick="checkAnswer(this, '${o.replace(/'/g, "\\'")}')" class="game-option-btn w-full py-3 px-4 rounded-lg font-medium text-gray-700 shadow-sm">${o}</button>`).join('');
            playAudio(currentQuestion.sound||currentQuestion.question);
        }

        function checkAnswer(btn, val){
            document.querySelectorAll('.game-option-btn').forEach(b=>b.disabled=true);
            if(currentQuestion.analysis){document.getElementById('gameAnalysisText').textContent=currentQuestion.analysis; document.getElementById('gameAnalysis').classList.remove('hidden');}
            if(val===currentQuestion.answer){
                btn.classList.add('correct'); streak++;
                document.getElementById('streak-count').textContent=streak;
                if(streak>0)document.getElementById('streak-icon').style.display='inline-block';
                
                // ★★★ 自動跳下一題 & 最後一題提醒 ★★★
                if(streak === TARGET_STREAK - 1) {
                    playFeedbackAudio("Excellent! One more to go!");
                    const hint = document.getElementById('lastOneHint');
                    hint.classList.remove('hidden');
                    hint.textContent = "最後一題！加油！(Last one!)";
                    setTimeout(nextQuestion, 2000); 
                } else if(streak === TARGET_STREAK) {
                    showReward(); // 直接顯示獎勵 (不放煙火)
                } else {
                    playFeedbackAudio("Excellent!");
                    setTimeout(nextQuestion, 1000); // 1秒後下一題
                }

            }else{
                btn.classList.add('wrong'); streak=0;
                document.getElementById('streak-count').textContent=streak;
                document.getElementById('streak-icon').style.display='none';
                document.getElementById('lastOneHint').classList.add('hidden');
                document.querySelectorAll('.game-option-btn').forEach(b=>{if(b.textContent.trim()===currentQuestion.answer)b.classList.add('correct');});
                playFeedbackAudio("Wrong answer.");
                
                // --- 挑戰失敗：按鈕變身 ---
                nextQBtn.innerHTML = '<i class="fas fa-redo-alt mr-2"></i> 再挑戰一次 (Try Again)';
                nextQBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                nextQBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function showReward(){
            // 同步放煙火 + 顯示卡片
            const fwLayer = document.getElementById('fireworksLayer');
            fwLayer.innerHTML = '';
            fwLayer.classList.remove('hidden');
            for(let i=0; i<15; i++) {
                const fw = document.createElement('div');
                fw.classList.add('firework');
                fw.style.top = Math.random()*80 + 10 + '%';
                fw.style.left = Math.random()*80 + 10 + '%';
                fw.style.animationDelay = Math.random()*1 + 's';
                fwLayer.appendChild(fw);
            }
            
            // ★增加挑戰成功人數計數
            callAPI({ action: "incrementChallengeCount" }).then(res => {
                if(res.status === "success") {
                    const msg = document.getElementById('rewardMsg'); 
                    msg.innerHTML = `STREAK 10 COMPLETED<br><span class="text-yellow-300 text-lg">你是第 ${res.count} 位挑戰成功的單字大師！</span>`;
                }
            });

            const card = pokemonData.length ? pokemonData[Math.floor(Math.random()*pokemonData.length)] : {"名稱":"Master","圖片":"","星等":5,"特殊":"傳說","英文名稱":"Master Ball"};
            const star = parseInt(card["星等"])||3;
            const attr = card["屬性"] || ""; // Default if empty? or empty string. Sheet has "草" etc.
            const special = card["特殊"] || "";
            const engName = card["英文名稱"] || "";

            // 分級樣式
            let cls="normal", hp="60 HP";
            if(special==="傳說" || special==="特殊") { cls="legendary"; hp="150 HP"; }
            else if(special==="幻之") { cls="mythical"; hp="120 HP"; }
            
            const img = (card["圖片"]&&card["圖片"].startsWith('http')) ? `<img src="${card["圖片"]}" class="poke-img-content" alt="${card["名稱"]}">` : `<i class="fas fa-dragon poke-img-placeholder animate-pulse" style="font-size:80px;color:#d4af37"></i>`;
            
            // 產生星星
            let starsHtml = '';
            for(let i=0; i<star; i++) starsHtml += '<i class="fas fa-star"></i>';

            // Tags Generation
            let tags = '';
            if(attr) tags += `<span class="card-tag tag-type mr-1">${attr}</span>`;
            if(special && special !== "一般") tags += `<span class="card-tag tag-special">${special}</span>`;

            // ★ 多樣化鼓勵語
            const msgs = [
                "每一次努力，都是通往夢想的階梯！",
                "相信自己，你的潛力無限大！",
                "學習的路上，你並不孤單，繼續加油！",
                "今天的汗水，是明天成功的養分。",
                "堅持到底，最美的風景就在頂峰。",
                "不怕慢，只怕站。持續進步就是贏家！",
                "你的認真，大家都看在眼裡，太棒了！",
                "每一個單字都是開啟新世界的鑰匙。",
                "失敗只是成功的墊腳石，勇敢挑戰吧！",
                "為自己感到驕傲吧！你正在變得更強。",
                "太厲害了！知識就是你的超能力。",
                "保持這份熱情，未來掌握在你手中！"
            ];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];

            // 決定語音內容
            let voiceMsg = `Congratulations! You got ${engName || 'a Pokemon'}!`;
            if(card["名稱"] && card["名稱"].indexOf("超夢") !== -1) {
                voiceMsg = "太神啦！恭喜你抽中了超夢！";
            }
            playFeedbackAudio(voiceMsg);

            document.getElementById('rewardCardContainer').innerHTML = `
            <div id="activePokeCard" class="poke-card ${cls}">
                <div class="holo-overlay"></div>
                <div class="poke-card-inner">
                    <div class="poke-header">
                        <div class="flex items-center flex-wrap gap-1">
                            ${tags}
                        </div>
                        <span class="text-red-600 font-bold font-mono text-sm">${hp}</span>
                    </div>
                    <div class="poke-img-frame">
                        <div class="glare"></div>
                        ${img}
                    </div>
                    <div class="poke-info">
                        <div class="poke-name">${card["名稱"]}</div>
                        <div class="poke-eng-name">${engName}</div>
                        <div class="poke-stars">${starsHtml}</div>
                        <div class="mt-2 pt-2 border-t border-gray-200 text-xs text-gray-600 italic leading-tight">${randomMsg}</div>
                    </div>
                </div>
            </div>`;

            document.getElementById('rewardModal').classList.add('show');
            
            const activeCard = document.getElementById('activePokeCard');
            if(activeCard) {
                const handleMove = (x, y) => {
                    const rect = activeCard.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    // 計算旋轉角度
                    const rotateX = ((y - rect.top - centerY) / centerY) * -15; // 倒轉 Y 軸
                    const rotateY = ((x - rect.left - centerX) / centerX) * 15;
                    
                    activeCard.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                    
                    // 調整反光位置
                    const glare = activeCard.querySelector('.glare');
                    if(glare) {
                        glare.style.background = `radial-gradient(circle at ${x - rect.left}px ${y - rect.top}px, rgba(255,255,255,0.8) 0%, transparent 50%)`;
                        glare.style.opacity = 1;
                    }
                };

                // 滑鼠監聽
                activeCard.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));
                activeCard.addEventListener('mouseleave', () => {
                    activeCard.style.transform = `perspective(1000px) rotateX(0) rotateY(0)`;
                    const glare = activeCard.querySelector('.glare');
                    if(glare) glare.style.opacity = 0;
                });

                // 手機觸控監聽
                activeCard.addEventListener('touchmove', (e) => {
                    e.preventDefault(); // 防止滾動
                    const touch = e.touches[0];
                    handleMove(touch.clientX, touch.clientY);
                }, { passive: false });

                activeCard.addEventListener('touchend', () => {
                    activeCard.style.transform = `perspective(1000px) rotateX(0) rotateY(0)`;
                    const glare = activeCard.querySelector('.glare');
                    if(glare) glare.style.opacity = 0;
                });
            }
        }

        function closeReward(){
            document.getElementById('rewardModal').classList.remove('show');
            document.getElementById('fireworksLayer').classList.add('hidden'); // 隱藏煙火
            streak=0; document.getElementById('streak-count').textContent=0; document.getElementById('streak-icon').style.display='none';
            document.getElementById('lastOneHint').classList.add('hidden');
            nextQuestion();
        }

        function playAudio(t){window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; u.rate=parseFloat(rateInput.value)||1.0; window.speechSynthesis.speak(u);}
        function speakQuote(){if(currentQuoteData)playAudio(currentQuoteData.en);}
        
        // 支援中文的語音播放
        function playFeedbackAudio(t){
            setTimeout(()=>{
                const u=new SpeechSynthesisUtterance(t); 
                u.lang=/[\u4e00-\u9fa5]/.test(t)?'zh-TW':'en-US'; 
                u.rate=1.1; 
                window.speechSynthesis.speak(u);
            },200);
        }
        
        function playCurrentGameAudio(){if(currentQuestion)playAudio(currentQuestion.sound||currentQuestion.question);}
        
        async function fetchYears(){try{const json=await callAPI({action:"getYears"});const sel=document.getElementById('yearSelect');if(json.status==="success"){sel.innerHTML='<option value="" disabled selected>請選擇學年度</option>';if(json.data.length===0)sel.innerHTML+='<option value="" disabled>無資料</option>';json.data.forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y;sel.appendChild(o);});}}catch(e){console.error(e);}}
        
        const els={studentId:document.getElementById('studentId'),idLast4:document.getElementById('idLast4'),toggleId:document.getElementById('toggleIdVisibility'),yearSelect:document.getElementById('yearSelect'),semSelect:document.getElementById('semesterSelect'),examSelect:document.getElementById('examSelect'),searchBtn:document.getElementById('searchBtn'),clearBtn:document.getElementById('clearBtn'),loading:document.getElementById('loading'),msgArea:document.getElementById('messageArea'),resArea:document.getElementById('resultArea'),resBody:document.getElementById('resultBody')};
        els.toggleId.addEventListener('click',()=>{const type=els.idLast4.type==='password'?'text':'password';els.idLast4.type=type;els.toggleId.querySelector('i').className=type==='password'?'fas fa-eye':'fas fa-eye-slash';});
        els.searchBtn.addEventListener('click',async()=>{const sid=els.studentId.value.trim(),pw=els.idLast4.value.trim(),yr=els.yearSelect.value;if(!sid||!pw||!yr){showMsg("請輸入完整查詢資訊","error");return;}setLoading(true);try{const res=await callAPI({action:"search",studentId:sid,idLast4:pw,year:yr,semester:els.semSelect.value,exam:els.examSelect.value});if(res.status==="success")renderTable(res.data);else{showMsg(res.message,"error");els.resArea.classList.add('hidden');}}catch(e){showMsg("連線錯誤","error");}finally{setLoading(false);}});
        els.clearBtn.addEventListener('click',()=>{els.studentId.value='';els.idLast4.value='';els.yearSelect.selectedIndex=0;els.resArea.classList.add('hidden');els.msgArea.classList.add('hidden');});
        function renderTable(data){els.resBody.innerHTML='';if(data.length===0){showMsg("查無資料","warn");els.resArea.classList.add('hidden');return;}els.msgArea.classList.add('hidden');els.resArea.classList.remove('hidden');const cols=["學年度","學期","段考","班級","座號","姓名","國語","英文","數學","歷史","地理","公民","自然","地科","加權平均","考科班排","考科校排"];data.forEach((r,i)=>{const tr=document.createElement('tr');tr.className="border-b border-gray-200 hover:bg-blue-50 transition duration-150 table-row-anim";tr.style.animationDelay=`${i*0.05}s`;cols.forEach(k=>{const td=document.createElement('td');td.className="py-4 px-6 whitespace-nowrap text-center";if(["學年度","學期","段考","班級","座號","姓名"].includes(k))td.classList.add("text-left","font-medium");if(k==="加權平均")td.classList.add("font-extrabold","text-red-600","bg-red-50");td.textContent=r[k]||"";tr.appendChild(td);});els.resBody.appendChild(tr);});els.resArea.scrollIntoView({behavior:'smooth',block:'start'});}
        function showMsg(txt,type){els.msgArea.textContent=txt;els.msgArea.className=`mt-6 text-center p-4 rounded-lg text-content-size font-bold ${type==='error'?'bg-red-100 text-red-700':'bg-orange-100 text-orange-800'}`;els.msgArea.classList.remove('hidden');}
        function setLoading(b){if(b){els.loading.classList.remove('hidden');els.resArea.classList.add('hidden');els.msgArea.classList.add('hidden');els.searchBtn.disabled=true;}else{els.loading.classList.add('hidden');els.searchBtn.disabled=false;}}
    </script>
</body>
</html>