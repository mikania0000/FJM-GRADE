<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鳳甲國中成績查詢系統</title>
    <!-- 引入 Tailwind CSS (快速排版) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;1,400&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* --- 動畫與通用樣式 --- */
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .loading-spinner { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-row-anim { opacity: 0; transform: translateX(-10px); animation: slideInLeft 0.5s ease-out forwards; }
        @keyframes slideInLeft { to { opacity: 1; transform: translateX(0); } }

        .text-title-size { font-size: 20px !important; line-height: 1.4; }
        .text-content-size { font-size: 18px !important; line-height: 1.4; }
        @media (min-width: 768px) { .text-title-size { font-size: 24px !important; } .text-content-size { font-size: 22px !important; } }

        .quote-container { background-color: #fff9c4; border-left: 5px solid #fbc02d; transition: all 0.3s ease; position: relative; }
        .quote-container:hover { transform: scale(1.01); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .font-english { font-family: 'Lora', serif; }
        .speak-btn { cursor: pointer; transition: all 0.2s; }
        .speak-btn:hover { color: #d97706; transform: scale(1.1); }
        .speak-btn:active { transform: scale(0.95); }

        /* 單字互動特效 */
        .vocab-highlight { border-bottom: 2px dashed #d97706; cursor: pointer; color: #b45309; font-weight: 600; position: relative; transition: all 0.2s ease; display: inline-block; user-select: none; -webkit-tap-highlight-color: rgba(253, 230, 138, 0.5); }
        .vocab-highlight:hover, .vocab-highlight.active { background-color: #fef3c7; color: #92400e; transform: translateY(-2px); }

        /* 單字卡片 Tooltip */
        #vocabTooltip { opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; position: fixed; z-index: 10000; pointer-events: none; }
        #vocabTooltip.show { opacity: 1; visibility: visible; }
        .tooltip-arrow { position: absolute; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }
        .tooltip-arrow.bottom { bottom: -8px; border-top: 8px solid white; filter: drop-shadow(0 2px 1px rgba(0,0,0,0.1)); }
        .tooltip-arrow.top { top: -8px; border-bottom: 8px solid white; filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.1)); }

        /* 遊戲區塊樣式 */
        .game-container { background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 4px solid #10b981; transition: all 0.3s ease; }
        .game-option-btn { border: 2px solid #e5e7eb; background-color: white; transition: all 0.2s; font-size: 1.1rem; }
        .game-option-btn:hover:not(:disabled) { border-color: #3b82f6; background-color: #eff6ff; transform: translateY(-2px); }
        .game-option-btn.correct { background-color: #d1fae5; border-color: #10b981; color: #065f46; font-weight: bold; transform: scale(1.02); }
        .game-option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #fde68a; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #d97706; cursor: pointer; -webkit-appearance: none; margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* ================= 金銀銅卡特效樣式 ================= */
        .reward-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 20000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }
        .reward-overlay.show { opacity: 1; visibility: visible; }

        /* 寶可夢卡片容器 */
        .poke-card {
            width: 300px; height: 420px; border-radius: 18px; position: relative;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            transform-style: preserve-3d; animation: card-float 3s ease-in-out infinite;
            border: 8px solid; overflow: hidden; cursor: pointer; background-size: cover;
        }

        /* 閃卡等級：金 (Gold) - 5星 */
        .poke-card.gold { background: linear-gradient(135deg, #fceabb 0%, #f8b500 50%, #fceabb 100%); border-color: #b8860b; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
        .poke-card.gold .poke-img-frame { border-color: #d4af37; background: radial-gradient(circle, #fffbe0, #ffdf85); }
        .poke-card.gold h3 { color: #8a6e05; }

        /* 閃卡等級：銀 (Silver) - 4星 */
        .poke-card.silver { background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 50%, #e0e0e0 100%); border-color: #757575; box-shadow: 0 0 30px rgba(192, 192, 192, 0.8); }
        .poke-card.silver .poke-img-frame { border-color: #9e9e9e; background: radial-gradient(circle, #f5f5f5, #d6d6d6); }
        .poke-card.silver h3 { color: #424242; }

        /* 閃卡等級：銅 (Bronze) - 3星及以下 */
        .poke-card.bronze { background: linear-gradient(135deg, #E6A27C 0%, #B87333 50%, #E6A27C 100%); border-color: #8B4513; box-shadow: 0 0 30px rgba(205, 127, 50, 0.6); }
        .poke-card.bronze .poke-img-frame { border-color: #A0522D; background: radial-gradient(circle, #fff0e0, #e6bea0); }
        .poke-card.bronze h3 { color: #5D4037; }

        .poke-card-inner { width: 100%; height: 100%; background: rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; padding: 10px; position: relative; z-index: 2; }
        .poke-header { width: 100%; display: flex; justify-content: space-between; padding: 0 5px; font-weight: bold; color: rgba(0,0,0,0.7); margin-bottom: 5px; text-shadow: 0 1px 1px rgba(255,255,255,0.5); }
        
        .poke-img-frame {
            width: 90%; height: 55%; margin-bottom: 10px;
            display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden;
            border-width: 4px; border-style: solid;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3); border-radius: 4px;
        }
        
        .poke-img-content { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; z-index: 10; }

        .poke-card::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(115deg, transparent 20%, rgba(255,255,255,0.4) 25%, rgba(255,255,255,0.7) 30%, rgba(255,0,255,0.3) 35%, rgba(0,255,255,0.3) 40%, transparent 50%);
            z-index: 3; pointer-events: none; animation: holo-shine 4s linear infinite;
        }

        .sparkle {
            position: absolute; background: white; border-radius: 50%; box-shadow: 0 0 5px white; opacity: 0;
            animation: sparkle-anim 1.5s linear infinite; z-index: 20;
        }

        @keyframes holo-shine { 0% { transform: rotate(25deg) translateY(20%); opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { transform: rotate(25deg) translateY(-120%); opacity: 0; } }
        @keyframes card-float { 0%, 100% { transform: translateY(0) rotateY(0deg); } 50% { transform: translateY(-15px) rotateY(5deg); } }
        @keyframes sparkle-anim { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }

        .close-reward-btn {
            margin-top: 20px; background: white; color: #333; font-weight: bold; padding: 10px 30px;
            border-radius: 50px; border: none; cursor: pointer;
            box-shadow: 0 0 15px rgba(255,255,255,0.5); transition: all 0.2s; z-index: 20001;
        }
        .close-reward-btn:hover { transform: scale(1.1); background: #fff; color: #000; }
    </style>
</head>
<body class="flex flex-col items-center py-4 md:py-8 px-2 md:px-4">

    <!-- 金卡獎勵視窗 -->
    <div id="rewardModal" class="reward-overlay">
        <div class="flex flex-col items-center">
            <h2 class="text-white text-3xl md:text-5xl font-bold mb-8 animate-bounce text-center" style="text-shadow: 0 0 10px gold;">
                <i class="fas fa-crown text-yellow-300"></i> CHALLENGE CLEAR!
            </h2>
            <div id="rewardCardContainer" onclick="playAudio('Pikachu!')"></div>
            <button class="close-reward-btn" onclick="closeReward()">
                <i class="fas fa-check mr-2"></i> 領取獎勵 (Claim)
            </button>
            <p class="text-white mt-4 text-sm opacity-80">Streak 10 達成！</p>
        </div>
    </div>

    <!-- 單字 Tooltip (更新結構以配合 JS) -->
    <div id="vocabTooltip" class="bg-white border border-gray-200 shadow-2xl rounded-lg p-4 max-w-xs w-full md:w-80 text-left">
        <div class="flex justify-between items-start mb-1">
            <div>
                <h4 id="tt-word" class="text-xl font-bold text-blue-700 font-english capitalize inline-block"></h4>
                <span id="tt-ipa" class="text-sm text-gray-500 font-mono ml-2"></span> <!-- 音標 -->
            </div>
            <i class="fas fa-volume-up text-blue-500 animate-pulse"></i>
        </div>
        <div class="space-y-2">
            <p class="text-sm text-gray-800 border-l-2 border-blue-400 pl-2">
                <span id="tt-def-zh" class="font-bold"></span> 
            </p>
            
            <!-- 例句區塊 -->
            <div class="bg-blue-50 p-2 rounded text-xs mt-2 relative group min-h-[40px] hidden" id="tt-ex-container">
                <div id="tt-loading" class="absolute inset-0 flex items-center justify-center bg-blue-50 bg-opacity-80 hidden">
                    <div class="loading-spinner" style="width:16px; height:16px; border-width:2px; border-top-color:#2563eb;"></div>
                    <span class="ml-2 text-gray-500 italic">網路字典查詢中...</span>
                </div>
                <button id="btn-read-ex" class="absolute top-1 right-1 text-blue-300 hover:text-blue-600 transition-colors hidden" title="朗讀例句">
                    <i class="fas fa-volume-up"></i>
                </button>
                <p id="tt-ex-en" class="text-blue-900 font-english italic mb-1 pr-5"></p>
                <p id="tt-ex-zh" class="text-gray-600"></p>
            </div>

            <!-- 字根分析區塊 (如果有) -->
            <div id="tt-analysis-container" class="mt-2 pt-2 border-t border-gray-100 hidden">
                <p class="text-xs text-orange-600 font-bold mb-1"><i class="fas fa-project-diagram mr-1"></i>字根分析：</p>
                <p id="tt-analysis" class="text-xs text-gray-700"></p>
            </div>
        </div>
        <div id="tooltipArrow" class="tooltip-arrow bottom"></div>
    </div>

    <!-- 主容器 -->
    <div class="w-full max-w-7xl bg-white rounded-xl shadow-2xl overflow-hidden fade-in-up bg-opacity-95">
        <div class="w-full bg-blue-50 border-b border-gray-200 text-center relative group">
            <img src="https://lh3.googleusercontent.com/d/1JmsYaXfbxskAaw9WXraX2gyi6a0W9--1" alt="標題" referrerpolicy="no-referrer" class="max-w-full h-auto mx-auto object-contain" style="max-height: 200px; md:max-height: 250px;" onerror="this.style.display='none'; document.getElementById('backup-title').style.display='block';">
            <div id="backup-title" style="display:none;" class="py-10"><h1 class="font-bold text-gray-800 tracking-wide text-title-size">鳳甲國中成績查詢系統</h1><p class="text-sm text-gray-500 mt-2">(Google Drive 圖片讀取失敗)</p></div>
        </div>

        <div class="w-full px-4 md:px-6 py-4 bg-yellow-50">
            <div class="quote-container p-4 rounded-r-lg flex flex-col md:flex-row items-start md:items-center shadow-sm">
                <div class="mr-0 md:mr-5 text-yellow-600 mb-3 md:mb-0 self-start"><i class="fas fa-lightbulb text-3xl"></i></div>
                <div class="flex-1 w-full">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2 border-b border-yellow-200 pb-2">
                        <div class="flex flex-col">
                            <h3 class="font-bold text-gray-800 text-lg mb-0">每日名言佳句 Quote of the Day</h3>
                            <span class="text-xs text-orange-600 font-bold"><i class="fas fa-hand-pointer mr-1"></i>滑鼠移至(或點擊)英文單字查閱</span>
                        </div>
                        <div class="flex items-center bg-white px-3 py-1.5 rounded-full shadow-sm border border-yellow-100 mt-2 md:mt-0">
                            <span class="text-xs text-gray-500 mr-2 flex items-center"><i class="fas fa-tachometer-alt mr-1"></i> 語速</span>
                            <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.9" class="w-24 mr-2">
                            <span id="rateValue" class="text-xs font-bold text-yellow-700 w-8 text-right">0.9x</span>
                        </div>
                    </div>
                    <div id="dailyQuote" class="transition-opacity duration-300 mt-2 relative">
                        <div id="quoteLoading" class="flex items-center text-gray-500"><div class="loading-spinner mr-2" style="width:20px; height:20px; border-width:3px;"></div>讀取名言中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 單字遊戲區塊 -->
        <div class="w-full px-4 md:px-6 mb-4">
            <div class="game-container relative">
                <div class="flex justify-between items-center cursor-pointer select-none" onclick="toggleGame()">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center flex-wrap">
                        <i class="fas fa-gamepad text-green-500 mr-2 text-2xl"></i>
                        英文單字挑戰
                        <span class="ml-2 text-sm text-red-500 font-bold">國中1200單字挑戰(全對抽寶可夢)</span>
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Challenge</span>
                    </h3>
                    <i class="fas fa-chevron-down text-gray-400 transform transition-transform duration-300" id="gameToggleIcon"></i>
                </div>
                
                <div id="gameContent" class="hidden mt-4 border-t border-gray-100 pt-4">
                    <div id="gameLoading" class="hidden text-center py-10"><div class="loading-spinner mx-auto mb-2"></div><p class="text-gray-500">正在下載題庫...</p></div>
                    <div id="gameBody" class="hidden">
                        <div class="text-center mb-6 relative">
                            <div class="absolute top-0 right-0 text-xs text-gray-400">Goal: <span class="font-bold text-indigo-600">Streak 10</span></div>
                            <div id="q-word" class="text-4xl md:text-5xl font-bold text-indigo-600 font-english mb-2 tracking-wide">Loading...</div>
                            <div class="flex justify-center items-center gap-2 mb-2">
                                <span id="q-type" class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wider">Word</span>
                                <button onclick="playCurrentGameAudio()" class="text-gray-400 hover:text-indigo-600 focus:outline-none transition-colors"><i class="fas fa-volume-up text-xl"></i></button>
                            </div>
                            <p class="text-gray-500 text-sm">請選擇正確的中文意思：</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-grid"></div>
                        
                        <!-- 答題後的字根分析顯示區 -->
                        <div id="gameAnalysis" class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-gray-700 hidden text-center">
                            <i class="fas fa-search-plus text-yellow-600 mr-1"></i>
                            <span class="font-bold text-yellow-700">補充分析：</span>
                            <span id="gameAnalysisText"></span>
                        </div>

                        <div class="mt-6 flex justify-between items-center border-t border-gray-100 pt-4">
                            <div class="flex items-center">
                                <span class="text-sm text-gray-500 mr-2">連續答對 Streak:</span>
                                <span id="streak-count" class="font-bold text-orange-500 text-xl">0</span>
                                <span class="text-gray-300 mx-1">/</span>
                                <span class="text-gray-400 text-sm">10</span>
                                <i class="fas fa-fire text-orange-500 ml-1 animate-pulse" id="streak-icon" style="display:none;"></i>
                            </div>
                            <button onclick="nextQuestion()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md transition transform hover:scale-105 flex items-center">
                                下一題 Next <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6 lg:p-10">
            <form id="searchForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="studentId"><i class="fas fa-id-card text-blue-500 mr-2"></i>學號</label><input class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-content-size hover:shadow-md" id="studentId" type="text" placeholder="請輸入學號" required></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="idLast4"><i class="fas fa-lock text-blue-500 mr-2"></i>身分證後4碼</label><div class="relative"><input class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 pr-12 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-content-size hover:shadow-md" id="idLast4" type="password" placeholder="後4碼" maxlength="6" required><button type="button" id="toggleIdVisibility" class="absolute inset-y-0 right-0 px-4 flex items-center text-gray-500 hover:text-blue-600 focus:outline-none z-10 cursor-pointer transition-transform hover:scale-110"><i class="fas fa-eye text-2xl"></i></button></div></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="yearSelect"><i class="fas fa-calendar-alt text-blue-500 mr-2"></i>學年度</label><div class="relative"><select id="yearSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="" disabled selected>載入中...</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div></div></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="semesterSelect"><i class="fas fa-clock text-blue-500 mr-2"></i>學期 (選填)</label><div class="relative"><select id="semesterSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="">全部</option><option value="1">上學期 (1)</option><option value="2">下學期 (2)</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div></div></div>
                <div class="col-span-1"><label class="block text-gray-700 font-bold mb-2 text-title-size" for="examSelect"><i class="fas fa-file-alt text-blue-500 mr-2"></i>段考 (選填)</label><div class="relative"><select id="examSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="">全部</option><option value="1">第一次段考 (1)</option><option value="2">第二次段考 (2)</option><option value="3">第三次段考 (3)</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div></div></div>
                <div class="col-span-1 md:col-span-2 lg:col-span-3 flex flex-col sm:flex-row justify-center gap-4 md:gap-6 mt-6">
                    <button type="button" id="searchBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center shadow-md text-title-size"><i class="fas fa-search mr-3"></i> 查詢</button>
                    <button type="button" id="clearBtn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-12 rounded-lg focus:outline-none focus:ring-4 focus:ring-gray-300 transition duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center shadow-md text-title-size"><i class="fas fa-eraser mr-3"></i> 清除</button>
                </div>
            </form>
            <div id="messageArea" class="mt-6 text-center hidden p-4 rounded-lg text-content-size font-bold"></div>
            <div id="loading" class="hidden flex flex-col justify-center items-center mt-12 mb-8"><div class="loading-spinner mb-4" style="width: 50px; height: 50px; border-width: 6px;"></div><span class="text-gray-600 font-medium animate-pulse text-title-size">正在從資料庫查詢中...</span></div>
        </div>

        <div id="resultArea" class="hidden border-t-4 border-blue-600 bg-gray-50 transition-all duration-500">
            <div class="p-4 md:p-6">
                <h2 class="font-bold text-gray-800 mb-6 border-l-8 border-blue-500 pl-4 text-title-size">查詢結果</h2>
                <div class="table-container bg-white rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead><tr class="bg-gray-100 text-gray-800 uppercase font-bold tracking-wider text-title-size"><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">學年度</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">學期</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">段考</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">班級</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">座號</th><th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">姓名</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">國語</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">英文</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">數學</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">歷史</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">地理</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">公民</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">自然</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">地科</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 text-red-600 font-extrabold bg-red-50 whitespace-nowrap">加權平均</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 whitespace-nowrap">考科班排</th><th class="py-4 px-6 text-center border-b-2 border-gray-300 whitespace-nowrap">考科校排</th></tr></thead>
                        <tbody id="resultBody" class="text-gray-700 text-content-size"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="bg-gray-100 border-t border-gray-200 py-6 text-center text-gray-500 text-content-size px-4">&copy; <span id="currentYear"></span> 鳳甲國中成績查詢系統 | <span class="text-blue-500 italic font-english block md:inline mt-2 md:mt-0">Believe in yourself.</span></div>
    </div>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const GAS_URL = "https://script.google.com/macros/s/AKfycbykiv2Rn3tRq1eaR8Yee5m8hfEwCN1naxrE8BAxoBNyDAPlizkT7S9l_RIUOTTqctycvQ/exec";

        let quotes = [], gameData = [], pokemonData = [];
        let currentQuestion = null, currentQuoteData = null;
        let streak = 0, isGameOpen = false;
        const TARGET_STREAK = 10;
        const wordCache = {}; 

        const rateInput = document.getElementById('speechRate');
        const rateValue = document.getElementById('rateValue');
        const tooltip = document.getElementById('vocabTooltip');
        const ttWord = document.getElementById('tt-word'); // Removed ttPos variable
        const ttDefZh = document.getElementById('tt-def-zh');
        // 注意：這裡移除了 ttDefEn，因為 HTML 中已經沒有 id="tt-def-en"
        const ttExEn = document.getElementById('tt-ex-en'), ttExZh = document.getElementById('tt-ex-zh');
        const ttIpa = document.getElementById('tt-ipa'); // 音標
        const ttAnalysis = document.getElementById('tt-analysis'); // 字根分析 (Tooltip)
        const ttAnalysisContainer = document.getElementById('tt-analysis-container');
        const btnReadEx = document.getElementById('btn-read-ex');
        const ttExContainer = document.getElementById('tt-ex-container');
        const ttLoading = document.getElementById('tt-loading');

        rateInput.addEventListener('input', (e) => { rateValue.textContent = e.target.value + 'x'; });
        document.addEventListener('click', (e) => {
            if (!tooltip.contains(e.target) && !e.target.classList.contains('vocab-highlight')) hideTooltip();
        });
        btnReadEx.addEventListener('click', (e) => {
            e.stopPropagation();
            if(ttExEn.textContent) playAudio(ttExEn.textContent);
        });

        window.addEventListener('load', () => {
            fetchYears(); fetchQuotes(); fetchGameData(); fetchPokemon();
        });

        async function callAPI(payload) {
            const response = await fetch(GAS_URL, {
                method: 'POST', redirect: 'follow', referrerPolicy: 'no-referrer', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            try { return JSON.parse(text); } catch (e) { throw new Error("JSON Error"); }
        }

        async function fetchQuotes() { try { const res = await callAPI({ action: "getQuotes" }); if (res.status === "success" && res.data.length > 0) { quotes = res.data; showRandomQuote(); } else { document.getElementById('dailyQuote').innerHTML = '<p class="text-red-500">暫無名言資料</p>'; } } catch (e) { console.error(e); } }
        async function fetchGameData() { try { const res = await callAPI({ action: "getGameData" }); if (res.status === "success" && res.data.length > 0) { gameData = res.data; nextQuestion(); } } catch (e) { console.error(e); } }
        async function fetchPokemon() { try { const res = await callAPI({ action: "getPokemon" }); if (res.status === "success") pokemonData = res.data; } catch (e) { console.error(e); } }

        function processQuoteWithKeywords(data) {
            let html = data.en;
            if (!data.keywords || data.keywords.length === 0) return html;
            const kws = data.keywords.map((k, i) => ({ ...k, idx: i })).sort((a, b) => b.word.length - a.word.length);
            kws.forEach(k => {
                const esc = k.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                html = html.replace(new RegExp(`\\b(${esc})\\b`, 'gi'), (m) => `###${k.idx}###${m}###END###`);
            });
            return html.replace(/###(\d+)###(.*?)###END###/g, (m, i, t) => `<span class="vocab-highlight" data-kw-index="${i}" onclick="handleWordClick(event)">${t}</span>`);
        }

        function showRandomQuote() {
            if (quotes.length === 0) return;
            currentQuoteData = quotes[Math.floor(Math.random() * quotes.length)];
            const html = processQuoteWithKeywords(currentQuoteData);
            const container = document.getElementById('dailyQuote');
            container.style.opacity = 0;
            setTimeout(() => {
                container.innerHTML = `<p class="text-gray-800 font-medium text-xl mb-1">${currentQuoteData.zh}</p><div class="relative"><p class="text-gray-600 font-normal italic text-lg font-english mr-3 leading-loose" id="enQuoteText">${html}<button onclick="speakQuote()" class="inline-block ml-2 text-yellow-600 hover:text-yellow-800 speak-btn focus:outline-none align-middle" title="朗讀"><i class="fas fa-volume-up text-xl"></i></button></p></div>`;
                container.style.opacity = 1;
                document.querySelectorAll('.vocab-highlight').forEach(el => el.addEventListener('mouseenter', (e) => showTooltip(e.target)));
            }, 300);
        }

        function handleWordClick(e) { e.stopPropagation(); showTooltip(e.target); }

        async function showTooltip(el) {
            const idx = el.getAttribute('data-kw-index');
            const data = currentQuoteData.keywords[idx];
            if (!data) return;

            document.querySelectorAll('.vocab-highlight').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            playAudio(data.word);

            ttWord.textContent = data.word; // Removed ttPos.textContent assignment
            
            // 顯示字根分析 (如果有)
            if (data.analysis) {
                ttAnalysisContainer.classList.remove('hidden');
                ttAnalysis.textContent = data.analysis;
            } else {
                ttAnalysisContainer.classList.add('hidden');
            }

            const rect = el.getBoundingClientRect();
            const h = tooltip.offsetHeight || 200, w = tooltip.offsetWidth || 300;
            let top = rect.top - h - 12, left = rect.left + rect.width/2 - w/2;
            const arrow = document.getElementById('tooltipArrow');
            arrow.className = 'tooltip-arrow bottom';
            if (top < 10) { top = rect.bottom + 12; arrow.className = 'tooltip-arrow top'; }
            if (left < 10) left = 10;
            if (left + w > window.innerWidth - 10) left = window.innerWidth - w - 10;
            arrow.style.left = `${Math.min(Math.max(rect.left + rect.width/2 - left, 15), w - 15)}px`;
            tooltip.style.top = `${top}px`; tooltip.style.left = `${left}px`;
            tooltip.classList.add('show');

            if (!data.zh || !data.ex_en) {
                const key = data.word.toLowerCase();
                if (wordCache[key]) {
                    updateTooltip(wordCache[key]);
                } else {
                    ttLoading.classList.remove('hidden');
                    ttExContainer.classList.remove('hidden');
                    btnReadEx.style.display = 'none';
                    ttDefZh.textContent = "查詢中..."; ttExEn.textContent = ""; ttExZh.textContent = ""; ttIpa.textContent = "";
                    
                    try {
                        const res = await callAPI({ action: "getWordInfo", word: data.word });
                        if (res.status === "success") {
                            const info = res.data;
                            data.zh = info.def_zh; data.ex_en = info.ex_en; data.ex_zh = info.ex_zh; data.ipa = info.ipa;
                            wordCache[key] = data;
                            updateTooltip(data);
                        } else {
                            ttDefZh.textContent = "查詢失敗"; ttLoading.classList.add('hidden');
                        }
                    } catch (e) { ttDefZh.textContent = "網路錯誤"; ttLoading.classList.add('hidden'); }
                }
            } else {
                updateTooltip(data);
            }
        }

        function updateTooltip(data) {
            ttLoading.classList.add('hidden');
            ttDefZh.textContent = data.zh || "無中文翻譯";
            ttExEn.textContent = data.ex_en || "";
            ttExZh.textContent = data.ex_zh || "";
            ttIpa.textContent = data.ipa ? `[${data.ipa}]` : ""; // 顯示音標
            
            if (data.ex_en && data.ex_en !== "No example found.") {
                ttExContainer.classList.remove('hidden');
                btnReadEx.style.display = 'block';
            } else {
                ttExContainer.classList.add('hidden');
                btnReadEx.style.display = 'none';
            }
        }

        function hideTooltip() { tooltip.classList.remove('show'); document.querySelectorAll('.vocab-highlight').forEach(e => e.classList.remove('active')); }

        // 遊戲功能
        function toggleGame() {
            isGameOpen = !isGameOpen;
            const content = document.getElementById('gameContent'), icon = document.getElementById('gameToggleIcon');
            if(isGameOpen) {
                content.classList.remove('hidden'); icon.classList.add('rotate-180');
                if(gameData.length === 0) fetchGameData().then(nextQuestion);
            } else {
                content.classList.add('hidden'); icon.classList.remove('rotate-180');
            }
        }
        function nextQuestion() {
            if(gameData.length === 0) return;
            currentQuestion = gameData[Math.floor(Math.random() * gameData.length)];
            document.getElementById('q-word').textContent = currentQuestion.question;
            document.getElementById('q-type').textContent = currentQuestion.type;
            document.getElementById('gameAnalysis').classList.add('hidden'); // 隱藏上題的分析
            
            const opts = [...currentQuestion.options].sort(()=>Math.random()-0.5);
            document.getElementById('options-grid').innerHTML = opts.map(o => 
                `<button onclick="checkAnswer(this, '${o.replace(/'/g, "\\'")}')" class="game-option-btn w-full py-3 px-4 rounded-lg font-medium text-gray-700 shadow-sm">${o}</button>`
            ).join('');
            playAudio(currentQuestion.sound || currentQuestion.question);
        }
        function checkAnswer(btn, val) {
            document.querySelectorAll('.game-option-btn').forEach(b => b.disabled = true);
            
            // 顯示字根分析 (如果有)
            if (currentQuestion.analysis) {
                document.getElementById('gameAnalysisText').textContent = currentQuestion.analysis;
                document.getElementById('gameAnalysis').classList.remove('hidden');
            }

            if(val === currentQuestion.answer) {
                btn.classList.add('correct'); streak++;
                document.getElementById('streak-count').textContent = streak;
                if(streak > 0) document.getElementById('streak-icon').style.display = 'inline-block';
                playFeedbackAudio("Excellent!");
                if(streak === TARGET_STREAK) showReward();
            } else {
                btn.classList.add('wrong'); streak = 0;
                document.getElementById('streak-count').textContent = streak;
                document.getElementById('streak-icon').style.display = 'none';
                document.querySelectorAll('.game-option-btn').forEach(b => { if(b.textContent.trim()===currentQuestion.answer) b.classList.add('correct'); });
                playFeedbackAudio("Wrong answer.");
            }
        }
        function showReward() {
            const card = pokemonData.length ? pokemonData[Math.floor(Math.random() * pokemonData.length)] : { "名稱": "Master", "圖片": "", "星等": 5, "特殊": "特殊" };
            const star = parseInt(card["星等"]) || 3;
            const attr = card["屬性"] || ""; // 讀取屬性
            
            let cls = "bronze", hp = "60 HP";
            if(star>=5) { cls="gold"; hp="120 HP"; } else if(star===4) { cls="silver"; hp="90 HP"; }
            const img = (card["圖片"]&&card["圖片"].startsWith('http')) ? `<img src="${card["圖片"]}" class="poke-img-content">` : `<i class="fas fa-dragon poke-img-placeholder animate-pulse" style="font-size:80px;color:#d4af37"></i>`;
            
            // ★ 多樣化鼓勵語
            const msgs = [
                "每一次努力，都是通往夢想的階梯！",
                "相信自己，你的潛力無限大！",
                "學習的路上，你並不孤單，繼續加油！",
                "今天的汗水，是明天成功的養分。",
                "堅持到底，最美的風景就在頂峰。",
                "不怕慢，只怕站。持續進步就是贏家！",
                "你的認真，大家都看在眼裡，太棒了！",
                "每一個單字都是開啟新世界的鑰匙。",
                "失敗只是成功的墊腳石，勇敢挑戰吧！",
                "為自己感到驕傲吧！你正在變得更強。",
                "太厲害了！知識就是你的超能力。",
                "保持這份熱情，未來掌握在你手中！"
            ];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];

            // 決定語音內容
            let voiceMsg = "Congratulations! You got a Pokemon card!";
            // 檢查卡片名稱是否包含「超夢」
            if (card["名稱"] && card["名稱"].indexOf("超夢") !== -1) {
                voiceMsg = "太神啦！恭喜你抽中了超夢！";
            } else {
                // 如果不是超夢，也可以隨機唸一句鼓勵語 (可選)
                // voiceMsg = randomMsg; 
            }

            document.getElementById('rewardCardContainer').innerHTML = `
            <div class="poke-card ${cls}">
                <div class="poke-card-inner">
                    <div class="poke-header">
                        <div class="flex items-center">
                            ${attr ? `<span class="text-xs bg-gray-700 text-white px-1.5 py-0.5 rounded mr-1">${attr}</span>` : ''}
                            <span class="text-sm">${card["特殊"]||"一般"}</span>
                        </div>
                        <span class="text-red-600 font-bold">${hp}</span>
                    </div>
                    <div class="poke-img-frame">${img}</div>
                    <div class="text-center w-full">
                        <h3 class="text-xl font-bold">${card["名稱"]}</h3>
                        <p class="text-xs text-gray-700 italic border-b border-gray-400 pb-1 mb-1">Star Rank: ${star}</p>
                        <div class="text-left text-xs px-2 text-gray-800 font-medium">
                            <div class="flex justify-between mb-1">
                                <span><i class="fas fa-star text-yellow-500"></i> Vocabulary Hit</span>
                                <span>${star*10}+</span>
                            </div>
                            <p class="text-gray-700 transform scale-90 origin-left leading-tight">${randomMsg}</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            setTimeout(() => { 
                document.getElementById('rewardModal').classList.add('show'); 
                playFeedbackAudio(voiceMsg); // 播放語音
                const ce = document.querySelector('.poke-card'); 
                for(let i=0;i<5;i++) { 
                    const s = document.createElement('div'); 
                    s.className = 'sparkle'; 
                    const sz = Math.random()*20+10; 
                    s.style.width=`${sz}px`; s.style.height=`${sz}px`; 
                    s.style.top=`${Math.random()*100}%`; s.style.left=`${Math.random()*100}%`; 
                    s.style.animationDelay=`${Math.random()}s`; 
                    ce.appendChild(s); 
                } 
            }, 800);
        }
        function closeReward() {
            document.getElementById('rewardModal').classList.remove('show');
            streak = 0; document.getElementById('streak-count').textContent = 0; document.getElementById('streak-icon').style.display = 'none';
            nextQuestion();
        }
        function playAudio(t) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang='en-US'; u.rate=parseFloat(rateInput.value)||1.0; window.speechSynthesis.speak(u); }
        function speakQuote() { if(currentQuoteData) playAudio(currentQuoteData.en); }
        
        // ★ 更新後的 playFeedbackAudio (支援中文偵測)
        function playFeedbackAudio(t) { 
            setTimeout(()=>{
                const u=new SpeechSynthesisUtterance(t); 
                // 如果文字包含中文，使用中文語音
                u.lang = /[\u4e00-\u9fa5]/.test(t) ? 'zh-TW' : 'en-US';
                u.rate=1.1; 
                window.speechSynthesis.speak(u);
            },200); 
        }
        
        function playCurrentGameAudio() { if(currentQuestion) playAudio(currentQuestion.sound || currentQuestion.question); }
        async function fetchYears() { try { const json = await callAPI({ action: "getYears" }); const sel = document.getElementById('yearSelect'); if (json.status === "success") { sel.innerHTML = '<option value="" disabled selected>請選擇學年度</option>'; if(json.data.length===0) sel.innerHTML+='<option value="" disabled>無資料</option>'; json.data.forEach(y => { const o = document.createElement('option'); o.value=y; o.textContent=y; sel.appendChild(o); }); } } catch (e) { console.error(e); } }
        const els = { studentId: document.getElementById('studentId'), idLast4: document.getElementById('idLast4'), toggleId: document.getElementById('toggleIdVisibility'), yearSelect: document.getElementById('yearSelect'), semSelect: document.getElementById('semesterSelect'), examSelect: document.getElementById('examSelect'), searchBtn: document.getElementById('searchBtn'), clearBtn: document.getElementById('clearBtn'), loading: document.getElementById('loading'), msgArea: document.getElementById('messageArea'), resArea: document.getElementById('resultArea'), resBody: document.getElementById('resultBody') };
        els.toggleId.addEventListener('click', () => { const type = els.idLast4.type === 'password' ? 'text' : 'password'; els.idLast4.type = type; els.toggleId.querySelector('i').className = type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash'; });
        els.searchBtn.addEventListener('click', async () => {
            const sid = els.studentId.value.trim(), pw = els.idLast4.value.trim(), yr = els.yearSelect.value;
            if (!sid || !pw || !yr) { showMsg("請輸入完整查詢資訊", "error"); return; }
            setLoading(true);
            try { const res = await callAPI({ action: "search", studentId: sid, idLast4: pw, year: yr, semester: els.semSelect.value, exam: els.examSelect.value }); if (res.status === "success") renderTable(res.data); else { showMsg(res.message, "error"); els.resArea.classList.add('hidden'); } } catch (e) { showMsg("連線錯誤", "error"); } finally { setLoading(false); }
        });
        els.clearBtn.addEventListener('click', () => { els.studentId.value = ''; els.idLast4.value = ''; els.yearSelect.selectedIndex = 0; els.resArea.classList.add('hidden'); els.msgArea.classList.add('hidden'); });
        function renderTable(data) { els.resBody.innerHTML = ''; if (data.length === 0) { showMsg("查無資料", "warn"); els.resArea.classList.add('hidden'); return; } els.msgArea.classList.add('hidden'); els.resArea.classList.remove('hidden'); const cols = ["學年度", "學期", "段考", "班級", "座號", "姓名", "國語", "英文", "數學", "歷史", "地理", "公民", "自然", "地科", "加權平均", "考科班排", "考科校排"]; data.forEach((r, i) => { const tr = document.createElement('tr'); tr.className = "border-b border-gray-200 hover:bg-blue-50 transition duration-150 table-row-anim"; tr.style.animationDelay = `${i * 0.05}s`; cols.forEach(k => { const td = document.createElement('td'); td.className = "py-4 px-6 whitespace-nowrap text-center"; if (["學年度", "學期", "段考", "班級", "座號", "姓名"].includes(k)) td.classList.add("text-left", "font-medium"); if (k === "加權平均") td.classList.add("font-extrabold", "text-red-600", "bg-red-50"); td.textContent = r[k] || ""; tr.appendChild(td); }); els.resBody.appendChild(tr); }); els.resArea.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
        function showMsg(txt, type) { els.msgArea.textContent = txt; els.msgArea.className = `mt-6 text-center p-4 rounded-lg text-content-size font-bold ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-800'}`; els.msgArea.classList.remove('hidden'); }
        function setLoading(b) { if (b) { els.loading.classList.remove('hidden'); els.resArea.classList.add('hidden'); els.msgArea.classList.add('hidden'); els.searchBtn.disabled = true; } else { els.loading.classList.add('hidden'); els.searchBtn.disabled = false; } }
    </script>
</body>
</html>