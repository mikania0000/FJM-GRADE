<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鳳甲國中成績查詢系統</title>
    <!-- 引入 Tailwind CSS (快速排版) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome (圖示) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;1,400&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* ... (保留原本的通用樣式) ... */
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-row-anim { opacity: 0; transform: translateX(-10px); animation: slideInLeft 0.5s ease-out forwards; }
        @keyframes slideInLeft { to { opacity: 1; transform: translateX(0); } }
        .text-title-size { font-size: 20px !important; line-height: 1.4; }
        .text-content-size { font-size: 18px !important; line-height: 1.4; }
        @media (min-width: 768px) { .text-title-size { font-size: 24px !important; } .text-content-size { font-size: 22px !important; } }
        .quote-container { background-color: #fff9c4; border-left: 5px solid #fbc02d; transition: all 0.3s ease; position: relative; }
        .quote-container:hover { transform: scale(1.01); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .font-english { font-family: 'Lora', serif; }
        .speak-btn { cursor: pointer; transition: all 0.2s; }
        .speak-btn:hover { color: #d97706; transform: scale(1.1); }
        .speak-btn:active { transform: scale(0.95); }
        .vocab-highlight { border-bottom: 2px dashed #d97706; cursor: pointer; color: #b45309; font-weight: 600; position: relative; transition: all 0.2s ease; display: inline-block; user-select: none; -webkit-tap-highlight-color: rgba(253, 230, 138, 0.5); }
        .vocab-highlight:hover, .vocab-highlight.active { background-color: #fef3c7; color: #92400e; transform: translateY(-2px); }
        #vocabTooltip { opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; position: fixed; z-index: 10000; pointer-events: none; }
        #vocabTooltip.show { opacity: 1; visibility: visible; }
        .tooltip-arrow { position: absolute; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }
        .tooltip-arrow.bottom { bottom: -8px; border-top: 8px solid white; filter: drop-shadow(0 2px 1px rgba(0,0,0,0.1)); }
        .tooltip-arrow.top { top: -8px; border-bottom: 8px solid white; filter: drop-shadow(0 -2px 1px rgba(0,0,0,0.1)); }
        .game-container { background: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 4px solid #10b981; transition: all 0.3s ease; }
        .game-option-btn { border: 2px solid #e5e7eb; background-color: white; transition: all 0.2s; font-size: 1.1rem; }
        .game-option-btn:hover:not(:disabled) { border-color: #3b82f6; background-color: #eff6ff; transform: translateY(-2px); }
        .game-option-btn.correct { background-color: #d1fae5; border-color: #10b981; color: #065f46; font-weight: bold; transform: scale(1.02); }
        .game-option-btn.wrong { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #fde68a; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #d97706; cursor: pointer; -webkit-appearance: none; margin-top: -5px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* ================= 金銀銅卡特效樣式 ================= */
        .reward-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 20000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }
        .reward-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* 寶可夢卡片容器 */
        .poke-card {
            width: 300px;
            height: 420px;
            border-radius: 18px;
            position: relative;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            transform-style: preserve-3d;
            animation: card-float 3s ease-in-out infinite;
            border: 8px solid;
            overflow: hidden;
            cursor: pointer;
            background-size: cover;
        }

        /* 閃卡等級：金 (Gold) - 5星 */
        .poke-card.gold {
            background: linear-gradient(135deg, #fceabb 0%, #f8b500 50%, #fceabb 100%);
            border-color: #b8860b;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }
        .poke-card.gold .poke-img-frame { border-color: #d4af37; background: radial-gradient(circle, #fffbe0, #ffdf85); }
        .poke-card.gold h3 { color: #8a6e05; }

        /* 閃卡等級：銀 (Silver) - 4星 */
        .poke-card.silver {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 50%, #e0e0e0 100%);
            border-color: #757575;
            box-shadow: 0 0 30px rgba(192, 192, 192, 0.8);
        }
        .poke-card.silver .poke-img-frame { border-color: #9e9e9e; background: radial-gradient(circle, #f5f5f5, #d6d6d6); }
        .poke-card.silver h3 { color: #424242; }

        /* 閃卡等級：銅 (Bronze) - 3星及以下 */
        .poke-card.bronze {
            background: linear-gradient(135deg, #E6A27C 0%, #B87333 50%, #E6A27C 100%);
            border-color: #8B4513;
            box-shadow: 0 0 30px rgba(205, 127, 50, 0.6);
        }
        .poke-card.bronze .poke-img-frame { border-color: #A0522D; background: radial-gradient(circle, #fff0e0, #e6bea0); }
        .poke-card.bronze h3 { color: #5D4037; }


        /* 內部內容 */
        .poke-card-inner {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            position: relative;
            z-index: 2;
        }

        .poke-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
            font-weight: bold;
            color: rgba(0,0,0,0.7);
            margin-bottom: 5px;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
        }

        .poke-img-frame {
            width: 90%;
            height: 55%;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            border-width: 4px;
            border-style: solid;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        /* ★ 關鍵特效：處理白底圖片 
           使用 mix-blend-mode: multiply 讓白色背景變透明，
           從而透出底下的閃卡背景，製造「印刷在閃卡上」的效果。
        */
        .poke-img-content {
            width: 100%;
            height: 100%;
            object-fit: contain;
            mix-blend-mode: multiply; 
            z-index: 10;
        }

        /* 閃卡流光特效 (Holo Effect) */
        .poke-card::before {
            content: "";
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(
                115deg,
                transparent 20%,
                rgba(255,255,255,0.4) 25%,
                rgba(255,255,255,0.7) 30%,
                rgba(255,0,255,0.3) 35%,
                rgba(0,255,255,0.3) 40%,
                transparent 50%
            );
            z-index: 3;
            pointer-events: none;
            animation: holo-shine 4s linear infinite;
        }

        /* 星星粒子 */
        .sparkle {
            position: absolute;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 5px white;
            opacity: 0;
            animation: sparkle-anim 1.5s linear infinite;
            z-index: 20;
        }

        @keyframes holo-shine {
            0% { transform: rotate(25deg) translateY(20%); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: rotate(25deg) translateY(-120%); opacity: 0; }
        }

        @keyframes card-float {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-15px) rotateY(5deg); }
        }

        @keyframes sparkle-anim {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        .close-reward-btn {
            margin-top: 20px;
            background: white;
            color: #333;
            font-weight: bold;
            padding: 10px 30px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
            transition: all 0.2s;
            z-index: 20001;
        }
        .close-reward-btn:hover {
            transform: scale(1.1);
            background: #fff;
            color: #000;
        }
    </style>
</head>
<body class="flex flex-col items-center py-4 md:py-8 px-2 md:px-4">

    <!-- 金卡獎勵視窗 (隱藏) -->
    <div id="rewardModal" class="reward-overlay">
        <div class="flex flex-col items-center">
            <h2 class="text-white text-3xl md:text-5xl font-bold mb-8 animate-bounce text-center" style="text-shadow: 0 0 10px gold;">
                <i class="fas fa-crown text-yellow-300"></i> CHALLENGE CLEAR!
            </h2>
            
            <!-- 卡片容器，內容由 JS 動態生成 -->
            <div id="rewardCardContainer" onclick="playAudio('Pikachu!')">
                <!-- JS 會在這裡插入 .poke-card -->
            </div>

            <button class="close-reward-btn" onclick="closeReward()">
                <i class="fas fa-check mr-2"></i> 領取獎勵 (Claim)
            </button>
            <p id="rewardMsg" class="text-white mt-4 text-sm opacity-80">Streak 10 達成！</p>
        </div>
    </div>

    <!-- 單字卡片 Tooltip (保持不變) -->
    <div id="vocabTooltip" class="bg-white border border-gray-200 shadow-2xl rounded-lg p-4 max-w-xs w-full md:w-80 text-left">
        <div class="flex justify-between items-start mb-2">
            <div>
                <h4 id="tt-word" class="text-xl font-bold text-blue-700 font-english capitalize"></h4>
                <span id="tt-pos" class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded italic"></span>
            </div>
            <i class="fas fa-volume-up text-blue-500 animate-pulse"></i>
        </div>
        <div class="space-y-2">
            <p class="text-sm text-gray-800 border-l-2 border-blue-400 pl-2"><span id="tt-def-zh" class="font-bold"></span> <span id="tt-def-en" class="text-gray-500 text-xs block mt-0.5"></span></p>
            <div class="bg-blue-50 p-2 rounded text-xs mt-2">
                <p id="tt-ex-en" class="text-blue-900 font-english italic mb-1"></p>
                <p id="tt-ex-zh" class="text-gray-600"></p>
            </div>
        </div>
        <div id="tooltipArrow" class="tooltip-arrow bottom"></div>
    </div>

    <!-- 主容器 -->
    <div class="w-full max-w-7xl bg-white rounded-xl shadow-2xl overflow-hidden fade-in-up bg-opacity-95">
        
        <!-- 標題圖片區 -->
        <div class="w-full bg-blue-50 border-b border-gray-200 text-center relative group">
            <img src="https://lh3.googleusercontent.com/d/1JmsYaXfbxskAaw9WXraX2gyi6a0W9--1" 
                 alt="成績查詢系統標題" 
                 referrerpolicy="no-referrer"
                 class="max-w-full h-auto mx-auto object-contain"
                 style="max-height: 200px; md:max-height: 250px;" 
                 onerror="this.style.display='none'; document.getElementById('backup-title').style.display='block';">
            <div id="backup-title" style="display:none;" class="py-10">
                <h1 class="font-bold text-gray-800 tracking-wide text-title-size">鳳甲國中成績查詢系統</h1>
                <p class="text-sm text-gray-500 mt-2">(若圖片無法顯示，請確認 Google Drive 檔案權限是否設為「公開」)</p>
            </div>
        </div>

        <!-- 溫馨小語區塊 -->
        <div class="w-full px-4 md:px-6 py-4 bg-yellow-50">
            <div class="quote-container p-4 rounded-r-lg flex flex-col md:flex-row items-start md:items-center shadow-sm">
                <div class="mr-0 md:mr-5 text-yellow-600 mb-3 md:mb-0 self-start">
                    <i class="fas fa-lightbulb text-3xl"></i>
                </div>
                <div class="flex-1 w-full">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2 border-b border-yellow-200 pb-2">
                        <div class="flex flex-col">
                            <h3 class="font-bold text-gray-800 text-lg mb-0">每日名言佳句 Quote of the Day</h3>
                            <span class="text-xs text-orange-600 font-bold"><i class="fas fa-hand-pointer mr-1"></i>滑鼠移至(或點擊)英文單字查閱</span>
                        </div>
                        <div class="flex items-center bg-white px-3 py-1.5 rounded-full shadow-sm border border-yellow-100 mt-2 md:mt-0">
                            <span class="text-xs text-gray-500 mr-2 flex items-center"><i class="fas fa-tachometer-alt mr-1"></i> 語速</span>
                            <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.9" class="w-24 mr-2">
                            <span id="rateValue" class="text-xs font-bold text-yellow-700 w-8 text-right">0.9x</span>
                        </div>
                    </div>
                    <div id="dailyQuote" class="transition-opacity duration-300 mt-2 relative">
                        <div id="quoteLoading" class="flex items-center text-gray-500"><div class="loading-spinner mr-2" style="width:20px; height:20px; border-width:3px;"></div>讀取名言中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 英文挑戰遊戲區塊 -->
        <div class="w-full px-4 md:px-6 mb-4">
            <div class="game-container relative">
                <div class="flex justify-between items-center cursor-pointer select-none" onclick="toggleGame()">
                    <!-- ★★★ 修改後的標題區塊 ★★★ -->
                    <h3 class="font-bold text-gray-800 text-lg flex items-center flex-wrap">
                        <i class="fas fa-gamepad text-green-500 mr-2 text-2xl"></i>
                        英文單字挑戰
                        <span class="ml-2 text-sm text-red-500 font-bold">國中1200單字挑戰(全對抽寶可夢)</span>
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Challenge</span>
                    </h3>
                    <i class="fas fa-chevron-down text-gray-400 transform transition-transform duration-300" id="gameToggleIcon"></i>
                </div>
                
                <div id="gameContent" class="hidden mt-4 border-t border-gray-100 pt-4">
                    <div id="gameLoading" class="hidden text-center py-10">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <p class="text-gray-500">正在下載題庫...</p>
                    </div>

                    <div id="gameBody" class="hidden">
                        <div class="text-center mb-6 relative">
                            <div class="absolute top-0 right-0 text-xs text-gray-400">Goal: <span class="font-bold text-indigo-600">Streak 10</span></div>
                            <div id="q-word" class="text-4xl md:text-5xl font-bold text-indigo-600 font-english mb-2 tracking-wide">Loading...</div>
                            <div class="flex justify-center items-center gap-2 mb-2">
                                <span id="q-type" class="inline-block bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wider">Word</span>
                                <button onclick="playCurrentGameAudio()" class="text-gray-400 hover:text-indigo-600 focus:outline-none transition-colors" title="重聽發音"><i class="fas fa-volume-up text-xl"></i></button>
                            </div>
                            <p class="text-gray-500 text-sm">請選擇正確的中文意思：</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="options-grid"></div>
                        <div class="mt-6 flex justify-between items-center border-t border-gray-100 pt-4">
                            <div class="flex items-center">
                                <span class="text-sm text-gray-500 mr-2">連續答對 Streak:</span>
                                <span id="streak-count" class="font-bold text-orange-500 text-xl">0</span>
                                <span class="text-gray-300 mx-1">/</span>
                                <span class="text-gray-400 text-sm">10</span>
                                <i class="fas fa-fire text-orange-500 ml-1 animate-pulse" id="streak-icon" style="display:none;"></i>
                            </div>
                            <button onclick="nextQuestion()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md transition transform hover:scale-105 flex items-center">
                                下一題 Next <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 查詢表單區 (保留不變) -->
        <div class="p-4 md:p-6 lg:p-10">
            <form id="searchForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="col-span-1">
                    <label class="block text-gray-700 font-bold mb-2 text-title-size" for="studentId"><i class="fas fa-id-card text-blue-500 mr-2"></i>學號</label>
                    <input class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-content-size hover:shadow-md" id="studentId" type="text" placeholder="請輸入學號" required>
                </div>
                <div class="col-span-1">
                    <label class="block text-gray-700 font-bold mb-2 text-title-size" for="idLast4"><i class="fas fa-lock text-blue-500 mr-2"></i>身分證後4碼</label>
                    <div class="relative">
                        <input class="shadow-sm appearance-none border border-gray-300 rounded w-full py-3 px-4 pr-12 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition text-content-size hover:shadow-md" id="idLast4" type="password" placeholder="後4碼" maxlength="6" required>
                        <button type="button" id="toggleIdVisibility" class="absolute inset-y-0 right-0 px-4 flex items-center text-gray-500 hover:text-blue-600 focus:outline-none z-10 cursor-pointer transition-transform hover:scale-110"><i class="fas fa-eye text-2xl"></i></button>
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-gray-700 font-bold mb-2 text-title-size" for="yearSelect"><i class="fas fa-calendar-alt text-blue-500 mr-2"></i>學年度</label>
                    <div class="relative">
                        <select id="yearSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="" disabled selected>載入中...</option></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div>
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-gray-700 font-bold mb-2 text-title-size" for="semesterSelect"><i class="fas fa-clock text-blue-500 mr-2"></i>學期 (選填)</label>
                    <div class="relative">
                        <select id="semesterSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="">全部</option><option value="1">上學期 (1)</option><option value="2">下學期 (2)</option></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div>
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-gray-700 font-bold mb-2 text-title-size" for="examSelect"><i class="fas fa-file-alt text-blue-500 mr-2"></i>段考 (選填)</label>
                    <div class="relative">
                        <select id="examSelect" class="block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-4 py-3 pr-10 rounded shadow-sm leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer text-content-size hover:shadow-md"><option value="">全部</option><option value="1">第一次段考 (1)</option><option value="2">第二次段考 (2)</option><option value="3">第三次段考 (3)</option></select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-600"><i class="fas fa-chevron-down text-xl"></i></div>
                    </div>
                </div>
                <div class="col-span-1 md:col-span-2 lg:col-span-3 flex flex-col sm:flex-row justify-center gap-4 md:gap-6 mt-6">
                    <button type="button" id="searchBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-12 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center shadow-md text-title-size"><i class="fas fa-search mr-3"></i> 查詢</button>
                    <button type="button" id="clearBtn" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-4 px-12 rounded-lg focus:outline-none focus:ring-4 focus:ring-gray-300 transition duration-200 transform hover:scale-105 hover:shadow-lg flex items-center justify-center shadow-md text-title-size"><i class="fas fa-eraser mr-3"></i> 清除</button>
                </div>
            </form>
            <div id="messageArea" class="mt-6 text-center hidden p-4 rounded-lg text-content-size font-bold"></div>
            <div id="loading" class="hidden flex flex-col justify-center items-center mt-12 mb-8">
                <div class="loading-spinner mb-4" style="width: 50px; height: 50px; border-width: 6px;"></div>
                <span class="text-gray-600 font-medium animate-pulse text-title-size">正在從資料庫查詢中...</span>
            </div>
        </div>

        <!-- 結果顯示區 (保留不變) -->
        <div id="resultArea" class="hidden border-t-4 border-blue-600 bg-gray-50 transition-all duration-500">
            <div class="p-4 md:p-6">
                <h2 class="font-bold text-gray-800 mb-6 border-l-8 border-blue-500 pl-4 text-title-size">查詢結果</h2>
                <div class="table-container bg-white rounded-lg shadow-sm border border-gray-200">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr class="bg-gray-100 text-gray-800 uppercase font-bold tracking-wider text-title-size">
                                <th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">學年度</th>
                                <th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">學期</th>
                                <th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">段考</th>
                                <th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">班級</th>
                                <th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">座號</th>
                                <th class="py-4 px-6 text-left border-b-2 border-gray-300 whitespace-nowrap">姓名</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">國語</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">英文</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">數學</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">歷史</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">地理</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">公民</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">自然</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 bg-blue-50 text-blue-900 whitespace-nowrap">地科</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 text-red-600 font-extrabold bg-red-50 whitespace-nowrap">加權平均</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 whitespace-nowrap">考科班排</th>
                                <th class="py-4 px-6 text-center border-b-2 border-gray-300 whitespace-nowrap">考科校排</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody" class="text-gray-700 text-content-size"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- 頁尾 -->
        <div class="bg-gray-100 border-t border-gray-200 py-6 text-center text-gray-500 text-content-size px-4">
            &copy; <span id="currentYear"></span> 鳳甲國中成績查詢系統 | <span class="text-blue-500 italic font-english block md:inline mt-2 md:mt-0">Believe in yourself.</span>
        </div>
    </div>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // **重要：請將此處替換為您發布後的 Web App URL**
        const GAS_URL = "https://script.google.com/macros/s/AKfycbykiv2Rn3tRq1eaR8Yee5m8hfEwCN1naxrE8BAxoBNyDAPlizkT7S9l_RIUOTTqctycvQ/exec";

        let quotes = [];
        let gameData = [];
        let pokemonData = []; // ★新：儲存寶可夢資料
        let currentQuestion = null;
        let currentQuoteData = null;
        let streak = 0;
        let isGameOpen = false;
        const TARGET_STREAK = 10;

        // UI 元素
        const rateInput = document.getElementById('speechRate');
        const rateValue = document.getElementById('rateValue');
        const tooltip = document.getElementById('vocabTooltip');
        const tooltipArrow = document.getElementById('tooltipArrow');
        const ttWord = document.getElementById('tt-word');
        const ttPos = document.getElementById('tt-pos');
        const ttDefZh = document.getElementById('tt-def-zh');
        const ttDefEn = document.getElementById('tt-def-en');
        const ttExEn = document.getElementById('tt-ex-en');
        const ttExZh = document.getElementById('tt-ex-zh');

        rateInput.addEventListener('input', (e) => { rateValue.textContent = e.target.value + 'x'; });
        document.addEventListener('click', (e) => {
            if (!tooltip.contains(e.target) && !e.target.classList.contains('vocab-highlight')) hideTooltip();
        });

        // 頁面載入時執行
        window.addEventListener('load', () => {
            fetchYears();     
            fetchQuotes();    
            fetchGameData();  
            fetchPokemon(); // ★新：載入寶可夢
        });

        // ---------------- API Fetch ----------------
        async function callAPI(payload) {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                redirect: 'follow', 
                referrerPolicy: 'no-referrer', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`HTTP 錯誤: ${response.status}`);
            const text = await response.text();
            try { return JSON.parse(text); } 
            catch (e) { throw new Error("伺服器回應格式錯誤"); }
        }

        async function fetchQuotes() {
            try {
                const response = await callAPI({ action: "getQuotes" });
                if (response.status === "success" && response.data.length > 0) {
                    quotes = response.data;
                    showRandomQuote();
                } else { document.getElementById('dailyQuote').innerHTML = '<p class="text-red-500">暫無名言資料</p>'; }
            } catch (e) { console.error("Fetch Quotes Error:", e); }
        }

        async function fetchGameData() {
            try {
                const response = await callAPI({ action: "getGameData" });
                if (response.status === "success" && response.data.length > 0) {
                    gameData = response.data;
                    nextQuestion();
                } else { console.warn("No game data found."); }
            } catch (e) { console.error("Fetch Game Data Error:", e); }
        }

        async function fetchPokemon() {
            try {
                const response = await callAPI({ action: "getPokemon" });
                if (response.status === "success") {
                    pokemonData = response.data;
                }
            } catch (e) { console.error("Fetch Pokemon Error:", e); }
        }

        // ... (Quote functions: processQuoteWithKeywords, showRandomQuote, etc. omitted for brevity, keep logic same) ...
        // ... (Game functions: toggleGame, nextQuestion, checkAnswer omitted for brevity, keep logic same) ...
        
        // ------------------ 縮減重複程式碼 (Quote) ------------------
        function processQuoteWithKeywords(quoteData) {
            let processedHtml = quoteData.en;
            if (!quoteData.keywords || quoteData.keywords.length === 0) return processedHtml;
            const sortedKeywords = quoteData.keywords.map((kw, index) => ({ ...kw, originalIndex: index })).sort((a, b) => b.word.length - a.word.length);
            sortedKeywords.forEach((kw) => {
                const escapedWord = kw.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
                const regex = new RegExp(`\\b(${escapedWord})\\b`, 'gi');
                processedHtml = processedHtml.replace(regex, (match) => `###${kw.originalIndex}###${match}###END###`);
            });
            processedHtml = processedHtml.replace(/###(\d+)###(.*?)###END###/g, (match, index, text) => `<span class="vocab-highlight" data-kw-index="${index}" onclick="handleWordClick(event)">${text}</span>`);
            return processedHtml;
        }

        function showRandomQuote() {
            if (quotes.length === 0) return;
            const quoteContainer = document.getElementById('dailyQuote');
            const randomIndex = Math.floor(Math.random() * quotes.length);
            currentQuoteData = quotes[randomIndex];
            const interactiveEnQuote = processQuoteWithKeywords(currentQuoteData);
            quoteContainer.style.opacity = 0;
            setTimeout(() => {
                quoteContainer.innerHTML = `<p class="text-gray-800 font-medium text-xl mb-1">${currentQuoteData.zh}</p><div class="relative"><p class="text-gray-600 font-normal italic text-lg font-english mr-3 leading-loose" id="enQuoteText">${interactiveEnQuote}<button onclick="speakQuote()" class="inline-block ml-2 text-yellow-600 hover:text-yellow-800 speak-btn focus:outline-none align-middle" title="朗讀整句"><i class="fas fa-volume-up text-xl"></i></button></p></div>`;
                quoteContainer.style.opacity = 1;
                attachKeywordEvents();
            }, 300);
        }

        function attachKeywordEvents() {
            document.querySelectorAll('.vocab-highlight').forEach(el => el.addEventListener('mouseenter', (e) => showTooltip(e.target)));
        }
        function handleWordClick(e) { e.stopPropagation(); showTooltip(e.target); }
        function showTooltip(targetElement) {
            const index = targetElement.getAttribute('data-kw-index');
            const keywordData = currentQuoteData.keywords[index];
            if (!keywordData) return;
            document.querySelectorAll('.vocab-highlight').forEach(el => el.classList.remove('active'));
            targetElement.classList.add('active');
            playAudio(keywordData.word);
            ttWord.textContent = keywordData.word;
            ttPos.textContent = keywordData.pos || "單字";
            ttDefZh.textContent = keywordData.zh || "";
            ttDefEn.textContent = keywordData.en || "";
            ttExEn.textContent = keywordData.ex_en ? `"${keywordData.ex_en}"` : "";
            ttExZh.textContent = keywordData.ex_zh || "";
            
            const rect = targetElement.getBoundingClientRect();
            const tooltipHeight = tooltip.offsetHeight || 200;
            const tooltipWidth = tooltip.offsetWidth || 300;
            let top = rect.top - tooltipHeight - 12; 
            let left = rect.left + (rect.width / 2) - (tooltipWidth / 2);
            tooltipArrow.className = 'tooltip-arrow bottom';
            if (top < 10) { top = rect.bottom + 12; tooltipArrow.className = 'tooltip-arrow top'; }
            if (left < 10) left = 10;
            if (left + tooltipWidth > window.innerWidth - 10) { left = window.innerWidth - tooltipWidth - 10; }
            let arrowLeft = rect.left + (rect.width / 2) - left;
            if (arrowLeft < 15) arrowLeft = 15;
            if (arrowLeft > tooltipWidth - 15) arrowLeft = tooltipWidth - 15;
            tooltipArrow.style.left = `${arrowLeft}px`;
            tooltipArrow.style.transform = 'translateX(-50%)';
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.classList.add('show');
        }
        function hideTooltip() { tooltip.classList.remove('show'); document.querySelectorAll('.vocab-highlight').forEach(el => el.classList.remove('active')); }

        // ------------------ 遊戲功能 ------------------
        function toggleGame() {
            isGameOpen = !isGameOpen;
            const content = document.getElementById('gameContent');
            const icon = document.getElementById('gameToggleIcon');
            if(isGameOpen) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
                if (gameData.length === 0) {
                    document.getElementById('gameLoading').classList.remove('hidden');
                    document.getElementById('gameBody').classList.add('hidden');
                    if(!currentQuestion) fetchGameData().then(() => { document.getElementById('gameLoading').classList.add('hidden'); document.getElementById('gameBody').classList.remove('hidden'); });
                } else {
                    document.getElementById('gameLoading').classList.add('hidden');
                    document.getElementById('gameBody').classList.remove('hidden');
                    if(!currentQuestion) nextQuestion();
                }
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
        
        function nextQuestion() {
            if (gameData.length === 0) return;
            const randomIndex = Math.floor(Math.random() * gameData.length);
            currentQuestion = gameData[randomIndex];
            document.getElementById('q-word').textContent = currentQuestion.question;
            document.getElementById('q-type').textContent = currentQuestion.type;
            let optionsForRender = [...currentQuestion.options];
            for (let i = optionsForRender.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [optionsForRender[i], optionsForRender[j]] = [optionsForRender[j], optionsForRender[i]];
            }
            const optionsHtml = optionsForRender.map(optText => `<button onclick="checkAnswer(this, '${optText.replace(/'/g, "\\'")}')" class="game-option-btn w-full py-3 px-4 rounded-lg font-medium text-gray-700 shadow-sm">${optText}</button>`).join('');
            document.getElementById('options-grid').innerHTML = optionsHtml;
            playCurrentGameAudio();
        }

        function checkAnswer(btn, selectedText) {
            const btns = document.querySelectorAll('.game-option-btn');
            btns.forEach(b => b.disabled = true); 
            if(selectedText === currentQuestion.answer) {
                btn.classList.add('correct');
                streak++;
                document.getElementById('streak-count').textContent = streak;
                if(streak > 0) document.getElementById('streak-icon').style.display = 'inline-block';
                playFeedbackAudio("Excellent!");
                if (streak === TARGET_STREAK) { showReward(); }
            } else {
                btn.classList.add('wrong');
                streak = 0;
                document.getElementById('streak-count').textContent = streak;
                document.getElementById('streak-icon').style.display = 'none';
                btns.forEach(b => { if(b.textContent.trim() === currentQuestion.answer) b.classList.add('correct'); });
                playFeedbackAudio("Wrong answer.");
            }
        }

        // ------------------ 金卡獎勵功能 (更新版) ------------------
        function showReward() {
            if (pokemonData.length === 0) {
                // 若無資料，使用預設 (fallback)
                renderRewardCard({
                    "名稱": "English Master",
                    "圖片": "", 
                    "星等": 5,
                    "特殊": "特殊"
                });
            } else {
                // 隨機抽一張
                const randIndex = Math.floor(Math.random() * pokemonData.length);
                const card = pokemonData[randIndex];
                renderRewardCard(card);
            }

            setTimeout(() => {
                const modal = document.getElementById('rewardModal');
                modal.classList.add('show');
                playFeedbackAudio("Congratulations! You got a Pokemon card!");
                
                // 動畫
                const cardElem = document.querySelector('.poke-card');
                for(let i=0; i<5; i++) { createSparkle(cardElem); }
            }, 800); 
        }

        function renderRewardCard(cardData) {
            const container = document.getElementById('rewardCardContainer');
            const star = parseInt(cardData["星等"]) || 3;
            
            // 判斷等級：5星=金, 4星=銀, 其他=銅
            let tierClass = "bronze";
            let hp = "60 HP";
            if (star >= 5) { tierClass = "gold"; hp = "120 HP"; }
            else if (star === 4) { tierClass = "silver"; hp = "90 HP"; }
            
            // 處理圖片：如果沒有圖片網址，用 icon 代替
            let imgContent = '';
            if (cardData["圖片"] && cardData["圖片"].startsWith('http')) {
                imgContent = `<img src="${cardData["圖片"]}" class="poke-img-content" alt="${cardData["名稱"]}">`;
            } else {
                imgContent = `<i class="fas fa-dragon poke-img-placeholder animate-pulse"></i>`;
            }

            const html = `
            <div class="poke-card ${tierClass}">
                <div class="poke-card-inner">
                    <div class="poke-header">
                        <span>${cardData["特殊"] || "一般"}</span>
                        <span class="text-red-600 font-bold">${hp}</span>
                    </div>
                    <div class="poke-img-frame">
                        ${imgContent}
                    </div>
                    <div class="text-center w-full">
                        <h3 class="text-xl font-bold">${cardData["名稱"]}</h3>
                        <p class="text-xs text-gray-700 italic border-b border-gray-400 pb-1 mb-1">Star Rank: ${star}</p>
                        <div class="text-left text-xs px-2 text-gray-800 font-medium">
                             <div class="flex justify-between mb-1">
                                <span><i class="fas fa-star text-yellow-500"></i> Vocabulary Hit</span>
                                <span>${star * 10}+</span>
                            </div>
                            <p class="text-gray-700 transform scale-90 origin-left leading-tight">
                                This card is proof of your English mastery. Keep learning!
                            </p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            container.innerHTML = html;
        }

        function closeReward() {
            const modal = document.getElementById('rewardModal');
            modal.classList.remove('show');
            streak = 0; 
            document.getElementById('streak-count').textContent = streak;
            document.getElementById('streak-icon').style.display = 'none';
            nextQuestion();
        }

        function createSparkle(parent) {
            const star = document.createElement('div');
            star.classList.add('sparkle');
            const size = Math.random() * 20 + 10;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random()}s`;
            parent.appendChild(star);
        }

        // ------------------ 語音/系統功能 (保留不變) ------------------
        function playAudio(text) {
            try { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = parseFloat(rateInput.value) || 1.0; window.speechSynthesis.speak(u); } catch (err) { console.log("Audio playback failed:", err); }
        }
        function playCurrentGameAudio() { if(!currentQuestion) return; playAudio(currentQuestion.sound || currentQuestion.question); }
        function speakQuote() { if (!currentQuoteData) return; playAudio(currentQuoteData.en); }
        function playFeedbackAudio(text) { setTimeout(() => { const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 1.1; window.speechSynthesis.speak(u); }, 200); }
        async function fetchYears() {
            try {
                const json = await callAPI({ action: "getYears" });
                const select = document.getElementById('yearSelect');
                if (json.status === "success") {
                    select.innerHTML = '<option value="" disabled selected>請選擇學年度</option>';
                    if (json.data.length === 0) select.innerHTML += '<option value="" disabled>無資料</option>';
                    json.data.forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.textContent = y; select.appendChild(opt); });
                } else { document.getElementById('messageArea').textContent = "無法載入學年度"; }
            } catch (error) { console.error(error); }
        }
        // ... (Search form logic remains same) ...
        const elements = { studentId: document.getElementById('studentId'), idLast4: document.getElementById('idLast4'), toggleIdVisibility: document.getElementById('toggleIdVisibility'), yearSelect: document.getElementById('yearSelect'), semesterSelect: document.getElementById('semesterSelect'), examSelect: document.getElementById('examSelect'), searchBtn: document.getElementById('searchBtn'), clearBtn: document.getElementById('clearBtn'), loading: document.getElementById('loading'), messageArea: document.getElementById('messageArea'), resultArea: document.getElementById('resultArea'), resultBody: document.getElementById('resultBody') };
        elements.toggleIdVisibility.addEventListener('click', () => { const input = elements.idLast4; const icon = elements.toggleIdVisibility.querySelector('i'); if (input.type === 'password') { input.type = 'text'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } else { input.type = 'password'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } });
        elements.searchBtn.addEventListener('click', async () => {
            const studentId = elements.studentId.value.trim(); const idLast4 = elements.idLast4.value.trim(); const year = elements.yearSelect.value;
            if (!studentId || !idLast4 || !year) { elements.messageArea.textContent = "請輸入完整查詢資訊"; elements.messageArea.classList.remove('hidden'); return; }
            setLoadingState(true);
            try {
                const json = await callAPI({ action: "search", studentId, idLast4, year, semester: elements.semesterSelect.value, exam: elements.examSelect.value });
                if (json.status === "success") renderTable(json.data); else { elements.messageArea.textContent = json.message; elements.messageArea.classList.remove('hidden'); elements.resultArea.classList.add('hidden'); }
            } catch (error) { elements.messageArea.textContent = "連線錯誤"; elements.messageArea.classList.remove('hidden'); } finally { setLoadingState(false); }
        });
        elements.clearBtn.addEventListener('click', () => { elements.studentId.value = ''; elements.idLast4.value = ''; elements.yearSelect.selectedIndex = 0; elements.resultArea.classList.add('hidden'); elements.messageArea.classList.add('hidden'); });
        function renderTable(data) {
            elements.resultBody.innerHTML = '';
            if (data.length === 0) { elements.messageArea.textContent = "查無資料"; elements.messageArea.classList.remove('hidden'); elements.resultArea.classList.add('hidden'); return; }
            elements.messageArea.classList.add('hidden'); elements.resultArea.classList.remove('hidden');
            data.forEach((row, index) => {
                const tr = document.createElement('tr'); tr.className = "border-b border-gray-200 hover:bg-blue-50 transition duration-150 table-row-anim"; tr.style.animationDelay = `${index * 0.1}s`;
                const fields = ["學年度", "學期", "段考", "班級", "座號", "姓名", "國語", "英文", "數學", "歷史", "地理", "公民", "自然", "地科", "加權平均", "考科班排", "考科校排"];
                fields.forEach(field => {
                    const td = document.createElement('td'); td.className = "py-4 px-6 whitespace-nowrap text-center";
                    if (["學年度", "學期", "段考", "班級", "座號", "姓名"].includes(field)) td.classList.add("text-left", "font-medium");
                    if (field === "加權平均") td.classList.add("font-extrabold", "text-red-600", "bg-red-50");
                    td.textContent = row[field] || ""; tr.appendChild(td);
                });
                elements.resultBody.appendChild(tr);
            });
            elements.resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        function setLoadingState(isLoading) {
            if (isLoading) { elements.loading.classList.remove('hidden'); elements.resultArea.classList.add('hidden'); elements.messageArea.classList.add('hidden'); elements.searchBtn.disabled = true; } 
            else { elements.loading.classList.add('hidden'); elements.searchBtn.disabled = false; }
        }
    </script>
</body>
</html>